<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Region Management</title>
<style>
    body {
        font-family: Arial, sans-serif;
        font-size: 12px;
    }
    .header-container {
        display: flex;
        align-items: center; /* Align items to the center */
    }
    .header-container img {
        margin-right: 10px;
        height: 28px; /* Adjust the height as needed */
    }
    .header-container a {
        font-size: 18px;
    }
    .header-container .separator {
        font-size: 18px;
        margin: 0 10px;
    }
    h1 {
        font-size: 16px;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }
    h2 {
        font-size: 16px;
        margin: 10px 0;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 20px;
    }
    th, td {
        border: 1px solid black;
        padding: 6px;
        text-align: center;
        vertical-align: middle;
    }
    th {
        background-color: #f2f2f2;
        font-size: 14px;
    }
    .provider-title {
        display: flex;
        align-items: center;
        font-size: 16px;
    }

    .import-overlay {
        display: none;
        position: fixed;
        top: 70px;
        left: 0;
        width: 100%;
        height: calc(100% - 70px);
        background-color: rgba(0,0,0,0.8);
        justify-content: center;
        align-items: flex-start;
        overflow: auto;
    }
    .import-overlay-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: left;
        width: 66.67%;
        max-width: calc(100vw - 40px);
        margin: 20px auto;
        overflow-x: auto;
        position: relative;
    }
    .overlay-close-btn {
        background-color: #f0f0f0;
        color: #d9534f;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .overlay-close-btn:hover {
        background-color: #e0e0e0;
    }
    .fixed-header {
        position: fixed;
        top: 0;
        width: 97%;
        background-color: white;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        padding: 10px 20px;
        align-items: center;
        box-shadow: 0 4px 6px -6px #222;
        overflow-x: auto;
    }
    .fixed-action-buttons {
        display: flex;
        align-items: center;
    }
    .fixed-action-buttons button {
        margin-left: 10px;
    }
    .add-button {
        font-size: 14px;
        font-weight: bold;
        margin-left: 15px;
    }
    .content {
        margin-top: 70px;
    }
    .checkbox-cell {
        width: 5%;
    }
    .highlight-pastel-blue {
        color: #4A90E2;
        font-weight: bold;
    }
    .disabled-input {
        background-color: #f0f0f0;
        color: #a0a0a0;
        border: 1px solid #d0d0d0;
    }
    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .form-group label {
        width: 140px;
        text-align: right;
        margin-right: 10px;
        flex-shrink: 0;
    }
    .form-group input, .form-group textarea, .form-group select {
        flex: 1;
        min-width: 0;
    }
    .form-group button {
        margin-left: 10px;
    }
    .form-group.button-group {
        justify-content: center;
        margin-top: 20px;
    }
    .sensitive-input {
        background-color: #f8d7da;
        color: #495057;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }
    .pastel-blue-input {
        background-color: #cce4f7;
        color: #495057;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }
    .pastel-blue-text {
        color: #4A90E2;
        font-weight: bold;
    }
    .inline-form-group {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 10px;
        margin-bottom: 10px;
    }
    .region-section {
        margin-top: 20px;
    }
    .overlay-header {
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 1001;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .overlay-header .inline-form-group {
        margin: 0;
        flex: 1;
    }
    .overlay-header .add-form-group {
        display: flex;
        gap: 5px;
        align-items: center;
        display: none; /* Initially hide this group */
    }
    .overlay-header .add-form-group input[type="checkbox"] {
        margin: 0;
        vertical-align: middle;
    }
    .overlay-header .add-form-group button {
        margin-left: 5px;
    }
    .first-button {
        background-color: white;
        border: 1px solid #ced4da;
        border-radius: 3px;
        padding: 1px 4px;
        font-size: 10px;
        height: 22px;
        cursor: pointer;
    }
    .first-button:hover {
        background-color: #f2f2f2;
    }
    #providerFilterWrapper {
        display: flex;
        align-items: center;
        margin-left: 15px; /* Space between the filter and the title */
    }
    #providerFilter {
        margin-left: 5px; /* Space between the label and the filter */
    }
    .setup-flow {
        display: flex;
        align-items: center;
        margin-left: 20px;
        font-size: 12px;
    }
    .setup-btn {
        background-color: #666;
        color: #ddd;
        border: none;
        padding: 3px 8px;
        margin: 0 2px;
        border-radius: 3px;
        font-size: 12px !important;
        font-weight: normal;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        width: 82px;
        height: 20px;
        text-align: center;
        box-sizing: border-box;
        line-height: 14px;
        white-space: nowrap;
        vertical-align: middle;
    }
    .setup-btn:hover {
        background-color: #555;
        color: #ddd;
        text-decoration: none;
    }
    .setup-btn.active {
        background-color: #3399ff;
        color: white;
        font-weight: bold;
        cursor: default;
    }
    .setup-btn.active:hover {
        background-color: #1a8cff;
        color: white;
    }
    .setup-arrow {
        margin: 0 4px;
        color: #666;
        font-weight: bold;
    }
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }
    .loading-spinner.active {
        display: block;
    }
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
<script>
    // Basic Auth credentials from server
    const SPIDER_USERNAME = '{{.APIUsername}}';
    const SPIDER_PASSWORD = '{{.APIPassword}}';
    
    // Helper function to create fetch options with Basic Auth if credentials are set
    function createFetchOptions(options = {}) {
        const fetchOptions = { ...options };
        
        // Add Basic Auth header if credentials are provided
        if (SPIDER_USERNAME && SPIDER_PASSWORD) {
            const credentials = btoa(SPIDER_USERNAME + ':' + SPIDER_PASSWORD);
            fetchOptions.headers = {
                ...fetchOptions.headers,
                'Authorization': 'Basic ' + credentials
            };
        }
        
        return fetchOptions;
    }
    
    // Override fetch to automatically include Basic Auth
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
        // Only add auth headers for Spider API calls (not for external URLs)
        if (url.startsWith('/spider/') || url.startsWith('http://' + location.host + '/spider/')) {
            options = createFetchOptions(options);
        }
        return originalFetch(url, options);
    };

    let currentProviderKeys = [];
    let currentProviderRegionKeys = [];
    let currentRegions = [];
    let currentProviderName = "";
    let originalProviderFilter = 'All';

    function deleteRegion(regionName) {
        fetch(`/spider/region/${regionName}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.Result === "true") {
                    location.reload();
                } else {
                    alert("Failed to delete region");
                }
            })
            .catch(error => {
                alert("Error deleting region");
                console.error('Error:', error);
            });
    }

    function deleteSelectedRegions() {
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]:checked');
        const visibleCheckboxes = Array.from(checkboxes).filter(checkbox => {
            return checkbox.closest('tr').offsetParent !== null; // Check if the row is visible
        });

        if (visibleCheckboxes.length === 0) {
            alert("Please select regions to delete.");
            return;
        }

        if (!confirm("Are you sure you want to delete the selected regions?")) {
            return;
        }

        const deletePromises = visibleCheckboxes.map(checkbox => {
            const regionName = checkbox.value;
            return fetch(`/spider/region/${regionName}`, { method: 'DELETE' });
        });

        Promise.all(deletePromises)
            .then(responses => {
                for (let response of responses) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                }
                return Promise.all(responses.map(response => response.json()));
            })
            .then(dataList => {
                for (let data of dataList) {
                    if (data.Result !== "true") {
                        alert("Failed to delete some regions");
                        return;
                    }
                }
                // Reload with original provider filter
                const reloadUrl = (originalProviderFilter && originalProviderFilter !== 'All') ? 
                    `${window.location.pathname}?provider=${encodeURIComponent(originalProviderFilter)}` : 
                    window.location.pathname;
                window.location.href = reloadUrl;
            })
            .catch(error => {
                alert("Error deleting regions");
                console.error('Error:', error);
            });
    }

    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]');
        for (const checkbox of checkboxes) {
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
                checkbox.checked = source.checked;
            } else {
                checkbox.checked = false;
            }
        }
    }

    function toggleSelectTable(source, tableId) {
        const table = document.getElementById(tableId);
        const checkboxes = table.querySelectorAll('input[name="deleteCheckbox"]');
        for (const checkbox of checkboxes) {
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
                checkbox.checked = source.checked;
            } else {
                checkbox.checked = false;
            }
        }
    }

    function toggleImportSelectAll(source) {
        const checkboxes = document.querySelectorAll('input[name="importCheckbox"]');
        for (const checkbox of checkboxes) {
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
                checkbox.checked = source.checked;
            } else {
                checkbox.checked = false;
            }
        }
        
        // Update all table header checkboxes
        document.querySelectorAll('.region-section table thead input[type="checkbox"]').forEach(cb => {
            cb.checked = source.checked;
            cb.indeterminate = false;
        });
    }

    function toggleTableSelectAll(source, tableId) {
        const table = document.getElementById(tableId);
        const checkboxes = table.querySelectorAll('input[name="importCheckbox"]');
        for (const checkbox of checkboxes) {
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
                checkbox.checked = source.checked;
            } else {
                checkbox.checked = false;
            }
        }
        
        // Update main checkbox state
        updateImportMainCheckboxState();
    }

    function updateImportMainCheckboxState() {
        const allCheckboxes = document.querySelectorAll('input[name="importCheckbox"]');
        const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => {
            const row = cb.closest('tr');
            return row && row.style.display !== 'none';
        });
        
        const checkedCount = visibleCheckboxes.filter(cb => cb.checked).length;
        const mainCheckbox = document.querySelector('.add-form-group input[type="checkbox"]');
        
        if (!mainCheckbox) return;
        
        if (checkedCount === 0) {
            mainCheckbox.checked = false;
            mainCheckbox.indeterminate = false;
        } else if (checkedCount === visibleCheckboxes.length) {
            mainCheckbox.checked = true;
            mainCheckbox.indeterminate = false;
        } else {
            mainCheckbox.checked = false;
            mainCheckbox.indeterminate = true;
        }
        
        // Also update table header checkboxes
        document.querySelectorAll('.region-section table').forEach(table => {
            const tableCheckboxes = Array.from(table.querySelectorAll('input[name="importCheckbox"]')).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            const tableCheckedCount = tableCheckboxes.filter(cb => cb.checked).length;
            const headerCheckbox = table.querySelector('thead input[type="checkbox"]');
            
            if (headerCheckbox) {
                if (tableCheckedCount === 0) {
                    headerCheckbox.checked = false;
                    headerCheckbox.indeterminate = false;
                } else if (tableCheckedCount === tableCheckboxes.length) {
                    headerCheckbox.checked = true;
                    headerCheckbox.indeterminate = false;
                } else {
                    headerCheckbox.checked = false;
                    headerCheckbox.indeterminate = true;
                }
            }
        });
    }

    function validateForm() {
        const regionName = document.getElementById('regionName').value;
        const providerName = document.getElementById('providerName').value;
        let valid = true;

        currentProviderKeys.forEach((key, index) => {
            if (!document.getElementById(currentProviderRegionKeys[index]).value) {
                valid = false;
            }
        });

        if (!regionName || !providerName || !valid) {
            alert("Please fill in all the fields.");
            return false;
        }
        return true;
    }

    function escapeNewlines(str) {
        return str.replace(/\\n/g, "\n");
    }

    function postRegion() {
        if (!validateForm()) {
            return;
        }

        const regionName = document.getElementById('regionName').value;
        const providerName = document.getElementById('providerName').value;
        const keyValueInfoList = currentProviderKeys.map((key, index) => {
            const value = escapeNewlines(document.getElementById(currentProviderRegionKeys[index]).value);
            return { Key: key, Value: value };
        });

        const data = {
            RegionName: regionName,
            ProviderName: providerName,
            KeyValueInfoList: keyValueInfoList
        };

        fetch('/spider/region', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            alert("Error creating region");
            console.error('Error:', error);
        });
    }



    function showImportOverlay(providerName) {
        // Store the current filter selection
        originalProviderFilter = document.getElementById('providerFilter').value;
        
        currentProviderName = providerName;
        document.getElementById('currentProviderName').innerText = `${providerName}`;
        
        fetch('/spider/driver')
            .then(response => response.json())
            .then(data => {
                const driverSelect = document.getElementById('importDriverSelect');
                driverSelect.innerHTML = '';
                data.driver.forEach(driver => {
                    if (driver.ProviderName.toLowerCase() === providerName.toLowerCase()) {
                        const option = document.createElement('option');
                        option.value = driver.DriverName;
                        option.text = driver.DriverName;
                        driverSelect.add(option);
                    }
                });
            });

        fetch('/spider/credential')
            .then(response => response.json())
            .then(data => {
                const credentialSelect = document.getElementById('importCredentialSelect');
                credentialSelect.innerHTML = '';
                data.credential.forEach(credential => {
                    if (credential.ProviderName.toLowerCase() === providerName.toLowerCase()) {
                        const option = document.createElement('option');
                        option.value = credential.CredentialName;
                        option.text = credential.CredentialName;
                        credentialSelect.add(option);
                    }
                });
            });

        document.getElementById('importOverlay').style.display = 'flex';
        document.addEventListener('keydown', handleEsc);
    }

    function hideImportOverlay() {
        document.getElementById('importOverlay').style.display = 'none';
        document.removeEventListener('keydown', handleEsc);
        clearImportOverlay();
    }

    function clearImportOverlay() {
        document.getElementById('importDriverSelect').innerHTML = '';
        document.getElementById('importCredentialSelect').innerHTML = '';
        document.getElementById('importTableBody').innerHTML = '';
        document.querySelector('.add-form-group').style.display = 'none';
        document.getElementById('currentProviderName').innerText = '';
        document.getElementById('zoneStatusFilter').value = 'All'; // Reset zoneStatusFilter to 'All'
    }

    function generateRegionName() {
        const providerNameElement = document.getElementById('providerName');
        const providerName = providerNameElement ? providerNameElement.value.toLowerCase() : currentProviderName.toLowerCase();
        const region = document.getElementById('Region').value;
        let zone = document.getElementById('Zone').value;

        if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(zone)) {
            zone = zone.split('-')[0];
        }

        const regionName = `${providerName}_${region}_${zone}`;
        document.getElementById('regionName').value = regionName;
    }

    function fetchRegionZone() {
        const driverName = document.getElementById('importDriverSelect').value;
        const credentialName = document.getElementById('importCredentialSelect').value;

        if (!driverName || !credentialName) {
            alert('Please register and select a Driver and Credential first.');
            return;
        }

        document.getElementById('zoneStatusFilter').value = 'All'; // Reset zoneStatusFilter to 'All'

        // Show loading spinner
        const loadingSpinner = document.getElementById('loadingSpinner');
        const importTableBody = document.getElementById('importTableBody');
        loadingSpinner.classList.add('active');
        importTableBody.innerHTML = '';
        document.querySelector('.add-form-group').style.display = 'none';

        const fetchUrl = `/spider/preconfig/regionzone?DriverName=${driverName}&CredentialName=${credentialName}`;

        fetch(fetchUrl)
            .then(response => response.json())
            .then(data => {
                currentRegions = data.regionzone || [];
                renderImportTable();
                document.querySelector('.add-form-group').style.display = 'flex'; // Show the filter and buttons group
            })
            .catch(error => {
                alert(`Error fetching region and zone information: ${error}`);
                console.error('Error:', error);
            })
            .finally(() => {
                // Hide loading spinner
                loadingSpinner.classList.remove('active');
            });
    }

    function renderImportTable() {
        const importTableBody = document.getElementById('importTableBody');
        importTableBody.innerHTML = '';

        currentRegions.forEach((region, index) => {
            // Skip if region doesn't have ZoneList or it's not an array
            if (!region.ZoneList || !Array.isArray(region.ZoneList) || region.ZoneList.length === 0) {
                return;
            }

            const regionSection = document.createElement('div');
            regionSection.className = 'region-section';
            
            const regionTitle = document.createElement('h2');
            regionTitle.textContent = region.Name;
            regionSection.appendChild(regionTitle);
            
            const tableId = `table-${index}`;
            const table = document.createElement('table');
            table.id = tableId;
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Region</th>
                        <th>Zone</th>
                        <th>Zone Status</th>
                        <th style="color: #4A90E2; font-weight: bold;">Region Name</th>
                        <th class="checkbox-cell"><input type="checkbox" onclick="toggleTableSelectAll(this, '${tableId}')"></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            
            region.ZoneList.forEach(zone => {
                let zoneName = zone.Name;
                if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(zoneName)) {
                    zoneName = zoneName.split('-')[0];
                }

                const regionName = `${currentProviderName.toLowerCase()}_${region.Name}_${zoneName}`;
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${region.Name}</td>
                    <td>${zone.Name}</td>
                    <td>${zone.Status}</td>
                    <td><input type="text" value="${regionName}" placeholder="Enter region name" style="width: calc(100% - 2mm); background-color: #E3F2FD; border: 2px solid #4A90E2;" /></td>
                    <td class="checkbox-cell"><input type="checkbox" name="importCheckbox" /></td>
                `;
                table.querySelector('tbody').appendChild(row);
            });
            
            regionSection.appendChild(table);
            importTableBody.appendChild(regionSection);
        });

        const importHeader = document.querySelector('.add-form-group');
        if (importTableBody.innerHTML.trim()) {
            importHeader.style.display = 'flex';
        } else {
            importHeader.style.display = 'none';
        }
    }
    
    function groupOverlayRegionsByValue() {
        const importTableBody = document.getElementById('importTableBody');
        const sections = importTableBody.querySelectorAll('.region-section');
        
        sections.forEach((section, index) => {
            const table = section.querySelector('table');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) return;
            
            // Group rows by region value (first column - Region)
            const regionGroups = new Map();
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 3) return;
                
                // Original structure: Region(0), Zone(1), Zone Status(2), Region Name input(3), Checkbox(4)
                const regionValue = cells[0].textContent.trim();
                if (!regionGroups.has(regionValue)) {
                    regionGroups.set(regionValue, []);
                }
                regionGroups.get(regionValue).push(row);
            });
            
            // Always restructure to ensure consistent cell order
            // even if there's only one region group
            
            // Create new grouped structure
            const newContent = document.createElement('div');
            newContent.className = 'provider-regions';
            
            regionGroups.forEach((groupRows, regionValue) => {
                const regionSection = document.createElement('div');
                regionSection.className = 'region-section';
                
                const regionTitle = document.createElement('h3');
                regionTitle.textContent = regionValue;
                regionTitle.style.fontSize = '14px';
                regionTitle.style.fontWeight = 'bold';
                regionTitle.style.margin = '10px 0 5px 0';
                regionTitle.style.padding = '5px';
                regionTitle.style.backgroundColor = '#f0f0f0';
                regionTitle.style.borderLeft = '4px solid #4A90E2';
                regionSection.appendChild(regionTitle);
                
                const groupTable = document.createElement('table');
                groupTable.style.width = '100%';
                groupTable.style.borderCollapse = 'collapse';
                groupTable.style.marginBottom = '20px';
                
                const tableId = `overlay-${index}-${regionValue.replace(/[^a-zA-Z0-9]/g, '_')}`;
                groupTable.id = tableId;
                
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Region</th>
                        <th>Zone</th>
                        <th>Zone Status</th>
                        <th style="color: #4A90E2; font-weight: bold;">Region Name</th>
                        <th class="checkbox-cell"><input type="checkbox" onclick="toggleTableSelectAll(this, '${tableId}')"></th>
                    </tr>
                `;
                groupTable.appendChild(thead);
                
                const groupTbody = document.createElement('tbody');
                groupRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    
                    // Skip if not the expected structure
                    if (cells.length !== 5) {
                        console.warn("Skipping row with unexpected cell count:", cells.length);
                        return;
                    }
                    
                    // Check if cells have the expected structure
                    if (!cells[3] || !cells[3].querySelector('input') || 
                        !cells[4] || !cells[4].querySelector('input')) {
                        console.warn("Skipping row with missing input elements");
                        return;
                    }
                    
                    const newRow = document.createElement('tr');
                    
                    // Original order: Region(0), Zone(1), Zone Status(2), Region Name(3), Checkbox(4)
                    // New order: Region Name, Region, Zone, Zone Status, Checkbox
                    
                    // Region Name (input field)
                    const regionNameCell = document.createElement('td');
                    const inputClone = cells[3].querySelector('input').cloneNode(true);
                    inputClone.value = cells[3].querySelector('input').value;
                    regionNameCell.appendChild(inputClone);
                    newRow.appendChild(regionNameCell);
                    
                    // Region
                    const regionCell = document.createElement('td');
                    regionCell.textContent = cells[0].textContent;
                    newRow.appendChild(regionCell);
                    
                    // Zone
                    const zoneCell = document.createElement('td');
                    zoneCell.textContent = cells[1].textContent;
                    newRow.appendChild(zoneCell);
                    
                    // Zone Status
                    const zoneStatusCell = document.createElement('td');
                    zoneStatusCell.textContent = cells[2].textContent;
                    newRow.appendChild(zoneStatusCell);
                    
                    // Checkbox
                    const checkboxCell = document.createElement('td');
                    checkboxCell.className = 'checkbox-cell';
                    const checkboxClone = cells[4].querySelector('input').cloneNode(true);
                    checkboxClone.checked = cells[4].querySelector('input').checked;
                    checkboxCell.appendChild(checkboxClone);
                    newRow.appendChild(checkboxCell);
                    
                    groupTbody.appendChild(newRow);
                });
                groupTable.appendChild(groupTbody);
                
                regionSection.appendChild(groupTable);
                newContent.appendChild(regionSection);
            });
            
            // Replace original section with grouped content
            section.replaceWith(newContent);
        });
    }

    function addImportedRegions() {
        const checkboxes = document.querySelectorAll('input[name="importCheckbox"]:checked');
        const visibleCheckboxes = Array.from(checkboxes).filter(checkbox => {
            return checkbox.closest('tr').offsetParent !== null; // Check if the row is visible
        });

        if (visibleCheckboxes.length === 0) {
            alert("Please select regions to add.");
            return;
        }

        const addPromises = visibleCheckboxes.map(checkbox => {
            const row = checkbox.closest('tr');
            const regionName = row.querySelector('input[type="text"]').value;
            const region = row.cells[0].innerText;
            const zone = row.cells[1].innerText;
            const zoneStatus = row.cells[2].innerText;

            const keyValueInfoList = [
                { Key: "Region", Value: region },
                { Key: "Zone", Value: zone },
                { Key: "ZoneStatus", Value: zoneStatus }
            ];

            const data = {
                RegionName: regionName,
                ProviderName: currentProviderName,
                KeyValueInfoList: keyValueInfoList
            };

            return fetch('/spider/region', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        });

        Promise.all(addPromises)
            .then(responses => {
                for (let response of responses) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                }
                return Promise.all(responses.map(response => response.json()));
            })
            .then(() => {
                // Reload with original provider filter
                const reloadUrl = (originalProviderFilter && originalProviderFilter !== 'All') ? 
                    `${window.location.pathname}?provider=${encodeURIComponent(originalProviderFilter)}` : 
                    window.location.pathname;
                window.location.href = reloadUrl;
            })
            .catch(error => {
                alert("Error adding regions");
                console.error('Error:', error);
            });
    }

    function checkFirstItems() {
        const tables = document.querySelectorAll('#importTableBody table');
        tables.forEach(table => {
            const firstVisibleRow = Array.from(table.querySelectorAll('tbody tr')).find(row => row.style.display !== 'none');
            if (firstVisibleRow) {
                const firstCheckbox = firstVisibleRow.querySelector('input[name="importCheckbox"]');
                if (firstCheckbox) {
                    firstCheckbox.checked = !firstCheckbox.checked; // Toggle check status
                }
            }
        });
    }

    function handleEsc(event) {
        if (event.key === 'Escape') {
            hideImportOverlay();
        }
    }

    function filterProvider() {
        var providerFilter = document.getElementById("providerFilter").value;
        originalProviderFilter = providerFilter; // Update the filter state
        var titles = document.querySelectorAll(".provider-title");

        titles.forEach(function(title) {
            var providerName = title.id.replace("title-", "");
            var table = document.getElementById("table-" + providerName);
            
            if (providerFilter === "All" || providerFilter === providerName) {
                title.style.display = "";
                if (table) table.style.display = "";
            } else {
                title.style.display = "none";
                if (table) table.style.display = "none";
            }
        });

        // Also handle grouped provider-regions if they exist
        var providerRegions = document.querySelectorAll(".provider-regions");
        providerRegions.forEach(function(regions) {
            var previousTitle = regions.previousElementSibling;
            if (previousTitle && previousTitle.classList.contains('provider-title')) {
                var providerName = previousTitle.id.replace("title-", "");
                if (providerFilter === "All" || providerFilter === providerName) {
                    regions.style.display = "";
                } else {
                    regions.style.display = "none";
                }
            }
        });

        // Uncheck all checkboxes when the filter changes
        uncheckAllCheckboxes();
        // Uncheck the main delete checkbox
        document.querySelector('.fixed-action-buttons input[type="checkbox"]').checked = false;
    }

    function uncheckAllCheckboxes() {
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]');
        for (const checkbox of checkboxes) {
            checkbox.checked = false;
        }
    }

    function filterZoneStatus() {
        var zoneStatusFilter = document.getElementById("zoneStatusFilter").value;
        var tables = document.querySelectorAll("div.region-section table");

        tables.forEach(function(table) {
            var rows = table.querySelectorAll("tbody tr");
            rows.forEach(function(row) {
                if (row.cells.length > 2) {
                    // Column order: Region(0), Zone(1), Zone Status(2), Region Name(3), Checkbox(4)
                    var zoneStatus = row.cells[2].innerText.trim();
                    if (zoneStatusFilter === "All" || zoneStatus === zoneStatusFilter) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                        if (row.querySelector('input[name="importCheckbox"]')) {
                            row.querySelector('input[name="importCheckbox"]').checked = false;
                        }
                    }
                }
            });
        });

        // Uncheck all import checkboxes when the filter changes
        uncheckAllImportCheckboxes();
        // Uncheck the main import checkbox
        document.querySelector('.add-form-group input[type="checkbox"]').checked = false;
    }

    function uncheckAllImportCheckboxes() {
        const checkboxes = document.querySelectorAll('input[name="importCheckbox"]');
        for (const checkbox of checkboxes) {
            checkbox.checked = false;
        }
    }

    function goToSetupPage(page) {
        const selectedProvider = document.getElementById('providerFilter').value;
        let url = `/spider/adminweb/${page}`;
        
        // Add provider filter as URL parameter if not "All"
        if (selectedProvider !== 'All') {
            url += `?provider=${encodeURIComponent(selectedProvider)}`;
        }
        
        window.location.href = url;
    }

    function goToConnectionPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const providerParam = urlParams.get('provider');
        let url = '/spider/adminweb/connectionconfig';
        
        // Add provider filter as URL parameter if it exists
        if (providerParam) {
            url += `?provider=${encodeURIComponent(providerParam)}`;
        }
        
        window.location.href = url;
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        document.getElementById("providerFilter").addEventListener('change', filterProvider);
        document.getElementById("zoneStatusFilter").addEventListener('change', filterZoneStatus);
        
        // Group regions by region value
        groupRegionsByValue();
        
        // Read URL parameter and set the provider filter
        const urlParams = new URLSearchParams(window.location.search);
        const providerParam = urlParams.get('provider');
        
        if (providerParam) {
            const providerSelect = document.getElementById('providerFilter');
            // Check if the provider exists in the select options
            for (let option of providerSelect.options) {
                if (option.value === providerParam) {
                    providerSelect.value = providerParam;
                    originalProviderFilter = providerParam; // Update the original filter
                    filterProvider(); // Apply the filter
                    break;
                }
            }
        }
    });

    function groupRegionsByValue() {
        const content = document.querySelector('.content');
        const providers = content.querySelectorAll('.provider-title');
        
        providers.forEach(providerTitle => {
            const providerId = providerTitle.id.replace('title-', '');
            const table = document.getElementById(`table-${providerId}`);
            
            if (!table) return;
            
            const tbody = table.querySelector('tbody') || table;
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
                // Skip header rows and empty rows
                return row.querySelector('td') && !row.querySelector('td[colspan]');
            });
            
            if (rows.length === 0) return;
            
            // Check if this is a main page table (4 cells) or overlay table (5 cells)
            const firstRowCells = rows[0].querySelectorAll('td');
            const isMainPageTable = firstRowCells.length === 4;
            const isOverlayTable = firstRowCells.length === 5;
            
            if (!isMainPageTable && !isOverlayTable) {
                // Unknown table structure, skip
                return;
            }
            
            // Group rows by region value
            // Main page: cells[1] is Region
            // Overlay: cells[0] is Region
            const regionGroups = new Map();
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 2) return;
                
                const regionValue = isMainPageTable ? cells[1].textContent.trim() : cells[0].textContent.trim();
                if (!regionGroups.has(regionValue)) {
                    regionGroups.set(regionValue, []);
                }
                regionGroups.get(regionValue).push(row);
            });
            
            // Create new grouped structure
            const newContent = document.createElement('div');
            newContent.className = 'provider-regions';
            
            regionGroups.forEach((groupRows, regionValue) => {
                const regionSection = document.createElement('div');
                regionSection.className = 'region-section';
                
                const regionTitle = document.createElement('h3');
                regionTitle.textContent = regionValue;
                regionTitle.style.fontSize = '14px';
                regionTitle.style.fontWeight = 'bold';
                regionTitle.style.margin = '10px 0 5px 0';
                regionTitle.style.padding = '5px';
                regionTitle.style.backgroundColor = '#f0f0f0';
                regionTitle.style.borderLeft = '4px solid #4A90E2';
                regionSection.appendChild(regionTitle);
                
                const groupTable = document.createElement('table');
                groupTable.style.width = '100%';
                groupTable.style.borderCollapse = 'collapse';
                groupTable.style.marginBottom = '20px';
                
                const tableId = `${providerId}-${regionValue.replace(/[^a-zA-Z0-9]/g, '_')}`;
                groupTable.id = tableId;
                
                const thead = document.createElement('thead');
                if (isMainPageTable) {
                    // Main page: Region Name, Region, Zone, Checkbox
                    thead.innerHTML = `
                        <tr>
                            <th>Region Name</th>
                            <th>Region</th>
                            <th>Zone</th>
                            <th class="checkbox-cell"><input type="checkbox" onclick="toggleSelectTable(this, '${tableId}')"></th>
                        </tr>
                    `;
                } else {
                    // Overlay: Region Name, Region, Zone, Zone Status, Checkbox
                    thead.innerHTML = `
                        <tr>
                            <th>Region Name</th>
                            <th>Region</th>
                            <th>Zone</th>
                            <th>Zone Status</th>
                            <th class="checkbox-cell"><input type="checkbox" onclick="toggleSelectTable(this, '${tableId}')"></th>
                        </tr>
                    `;
                }
                groupTable.appendChild(thead);
                
                const groupTbody = document.createElement('tbody');
                groupRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    
                    if (isMainPageTable) {
                        // Main page table: just clone the row as-is
                        // Structure: Region Name(0), Region(1), Zone(2), Checkbox(3)
                        groupTbody.appendChild(row.cloneNode(true));
                    } else {
                        // Overlay table: needs reordering
                        // Skip if not the expected structure
                        if (cells.length !== 5) return;
                        
                        // Check if cells have the expected structure
                        if (!cells[3] || !cells[3].querySelector('input') || 
                            !cells[4] || !cells[4].querySelector('input')) return;
                        
                        const newRow = document.createElement('tr');
                        
                    // Order: Region, Zone, Zone Status, Region Name, Checkbox
                    // Original order: Region(0), Zone(1), Zone Status(2), Region Name(3), Checkbox(4)
                    
                    // Region
                    const regionCell = document.createElement('td');
                    regionCell.textContent = cells[0].textContent;
                    newRow.appendChild(regionCell);
                    
                    // Zone
                    const zoneCell = document.createElement('td');
                    zoneCell.textContent = cells[1].textContent;
                    newRow.appendChild(zoneCell);
                    
                    // Zone Status
                    const zoneStatusCell = document.createElement('td');
                    zoneStatusCell.textContent = cells[2].textContent;
                    newRow.appendChild(zoneStatusCell);
                    
                    // Region Name (input field)
                    const regionNameCell = document.createElement('td');
                    const inputClone = cells[3].querySelector('input').cloneNode(true);
                    inputClone.value = cells[3].querySelector('input').value;
                    regionNameCell.appendChild(inputClone);
                    newRow.appendChild(regionNameCell);
                        const checkboxCell = document.createElement('td');
                        checkboxCell.className = 'checkbox-cell';
                        const checkboxClone = cells[4].querySelector('input').cloneNode(true);
                        checkboxClone.checked = cells[4].querySelector('input').checked;
                        checkboxCell.appendChild(checkboxClone);
                        newRow.appendChild(checkboxCell);
                        
                        groupTbody.appendChild(newRow);
                    }
                });
                groupTable.appendChild(groupTbody);
                
                regionSection.appendChild(groupTable);
                newContent.appendChild(regionSection);
            });
            
            // Replace original table with grouped content
            table.replaceWith(newContent);
        });
    }
</script>
</head>
<body>
    <div class="fixed-header">
        <div class="header-container">
            <img src="/spider/adminweb/images/connection_small.png" alt="Connection Icon">
            <h1>
                <span style="min-width: 200px; flex-shrink: 0; display: inline-block;">Region Info Management</span>
                <div id="providerFilterWrapper">                    
                    <select id="providerFilter" onchange="filterProvider()">
                        <option value="All">All</option>
                        {{range $provider := .Providers}}
                        <option value="{{$provider}}">{{$provider}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="setup-flow">
                    <a href="javascript:void(0)" onclick="goToSetupPage('connectionconfig')" class="setup-btn">Connection</a>
                    <span style="margin: 0 8px; color: #666;">{</span>
                    <a href="javascript:void(0)" onclick="goToSetupPage('driver')" class="setup-btn">Driver</a>
                    <a href="javascript:void(0)" onclick="goToSetupPage('credential')" class="setup-btn" style="margin-left: 8px;">Credential</a>
                    <a href="javascript:void(0)" class="setup-btn active" style="margin-left: 8px;">Region/Zone</a>
                    <span style="margin-left: 8px; color: #666;">}</span>
                </div>
            </h1>
        </div>
        <div class="fixed-action-buttons">
            <input type="checkbox" onclick="toggleSelectAll(this)">
            <button onclick="deleteSelectedRegions()">Delete</button>
        </div>
    </div>
    
    <div class="content">
        {{range $provider := .Providers}}
        <div class="provider-title" id="title-{{$provider}}">
            <h2>{{$provider}}</h2>
            <button class="add-button" onclick="showImportOverlay('{{$provider}}')">+</button>
        </div>
        <table id="table-{{$provider}}">
            <tr>
                <th>Region Name</th>
                <th>Region</th>
                <th>Zone</th>
                <th class="checkbox-cell"><input type="checkbox" onclick="toggleSelectTable(this, 'table-{{$provider}}')"></th>
            </tr>
            {{if index $.Regions $provider}}
                {{range $region := index $.Regions $provider}}
                <tr>
                    <td>{{$region.RegionName}}</td>
                    <td>{{(index $region.KeyValueInfoList 0).Value}}</td>
                    <td>
                        {{if lt 1 (len $region.KeyValueInfoList) }}
                            {{(index $region.KeyValueInfoList 1).Value}}
                        {{else}}
                            N/A
                        {{end}}
                    </td>
                    <td class="checkbox-cell">
                        <input type="checkbox" name="deleteCheckbox" value="{{$region.RegionName}}">
                    </td>
                </tr>
                {{end}}
            {{else}}
            <tr>
                <td colspan="4">No regions found for {{$provider}}</td>
            </tr>
            {{end}}
        </table>
        {{end}}
    </div>



    <div id="importOverlay" class="import-overlay">
        <div class="import-overlay-content">
            <button type="button" class="overlay-close-btn" onclick="hideImportOverlay()">X</button>
            <h2>[<span id="currentProviderName"></span>] Add Region Info</h2>
            <div class="overlay-header">
                <div class="inline-form-group">
                    <label for="importDriverSelect">Driver:</label>
                    <select id="importDriverSelect" required></select>
                    <label for="importCredentialSelect">Credential:</label>
                    <select id="importCredentialSelect" required></select>
                    <button type="button" onclick="fetchRegionZone()">Fetch</button>
                    <button type="button" onclick="hideImportOverlay()">Cancel</button>
                </div>
                <div class="add-form-group">
                    <label for="zoneStatusFilter">Zone Status:</label>
                    <select id="zoneStatusFilter" onchange="filterZoneStatus()">
                        <option value="All">All</option>
                        <option value="Available">Available</option>
                        <option value="Unavailable">Unavailable</option>
                        <option value="StatusNotSupported">StatusNotSupported</option>
                    </select>
                    <button class="first-button" type="button" onclick="checkFirstItems()">1st</button>
                    <input type="checkbox" onclick="toggleImportSelectAll(this)">
                    <button type="button" onclick="addImportedRegions()">Add</button>
                </div>
            </div>
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner"></div>
                <p>Fetching region and zone information...</p>
            </div>
            <div id="importTableBody">
                <!-- Dynamically generated region sections will go here -->
            </div>
        </div>
    </div>
</body>
</html>
