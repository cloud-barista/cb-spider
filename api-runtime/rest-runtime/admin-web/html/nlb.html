<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NLB Management</title>
<style>
    body {
        font-family: Arial, sans-serif;
        font-size: 12px;
    }
    .header-container {
        display: flex;
        align-items: flex-end;
    }
    .header-container img {
        margin-right: 10px;
        height: 28px;
    }
    .header-container h1 {
        font-size: 16px;
        margin: 0;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 0;
    }
    th, td {
        border: 1px solid black;
        padding: 6px;
        position: relative;
    }
    th {
        background-color: #f2f2f2;
        font-size: 14px;
        text-align: center;
    }
    td {
        text-align: left;
    }
    .column-num {
        width: 5%;
        text-align: center;
    }

    .inner-table {
        width: 100%;
        table-layout: fixed;
    }
    .inner-table th {
        width: 30%;
        font-weight: normal;
        font-size: 12px;
        padding: 4px 8px; 
        text-align: right;
    }
    .inner-table td {
        width: 70%;
        font-size: 12px;
        padding: 4px 8px; 
        text-align: center;
    }
    
    .inner-table tr:nth-child(-n+2) td:nth-child(2) {
        background-color: #e0f7fa;
        color: #00796b;
        font-weight: bold;
        border: 1px solid #004d40;
    }
    .vm-list td {
        color: blue;
    }

    .inner-table-health {
        width: 100%;
        table-layout: fixed;
    }
    .inner-table-health th {
        width: 40%;
        font-weight: normal;
        font-size: 12px;
        padding: 4px 8px; 
        text-align: right;
    }
    .inner-table-health td {
        width: 60%;
        font-size: 12px;
        padding: 4px 8px; 
        text-align: center;
    }
    .inner-table-health tr:nth-child(-n+2) td:nth-child(2) {
        background-color: #e0f7fa;
        color: #00796b;
        font-weight: bold;
        border: 1px solid #004d40;
    }

    .center-align {
        text-align: center;
    }
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .overlay-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: left;
        font-family: Arial, sans-serif;
        font-size: 12px;
    }
    .fixed-header {
        position: fixed;
        top: 0;
        width: 97%;
        background-color: white;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        padding: 10px 20px;
        align-items: center;
        box-shadow: 0 4px 6px -6px #222;
    }
    .fixed-action-buttons {
        display: flex;
        align-items: center;
    }
    .fixed-action-buttons button {
        margin-left: 10px;
    }
    button.add-btn {
        width: 20px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
    }
    #searchInput {
        width: 190px;
        font-family: Arial, sans-serif;
        padding-right: 2.5cm;
    }
    #clearSearch {
        position: absolute;
        right: 0.1cm;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background-color: transparent;
        cursor: pointer;
        font-family: Arial, sans-serif;
    }
    .searchContainer {
        position: relative;
        display: flex;
        align-items: center;
        padding-left: 0.5cm;
    }
    .searchContainer button {
        position: absolute;
        right: 0.5cm;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background-color: transparent;
        cursor: pointer;
        font-family: Arial, sans-serif;
    }
    
    .add-button {
        font-size: 14px;
        font-weight: bold;
        margin-left: 1px;
        margin-right: 5px;
        margin-bottom: 10px;
    }
    .mock-add-button {
        margin-right: 1px;
    }
    .content {
        margin-top: 70px;
    }
    .highlight {
        background-color: #fffab6;
    }
    .checkbox-cell {
        width: 5%;
        text-align: center;
    }

    .nlb-name, .vpc-name, .scope-type, .listener, .vm-groups, .health-checker, .tags, .misc {
        text-align: center;
    }
    .nlb-name {
        width: 15%;
    }
    .vpc-name {
        width: 13%;
    }
    .scope-type {
        width: 10%;
    }
    .listener {
        width: 18%;
        vertical-align: top;
    }
    .vm-groups {
        width: 20%;
        vertical-align: top;
    }
    .health-checker {
        width: 13%;
        vertical-align: top;
    }
    .tags, .misc {
        width: 10%;
    }
    
    .tag-container {
        display: inline-block;
        background-color: #e1e1e1;
        border-radius: 3px;
        padding: 2px 5px;
        margin: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        max-width: calc(100% - 2ch);
    }
    .tag-container:hover {
        background-color: #c1e1c1;
    }

    .add-btn-container {
        margin-top: 5px;
        text-align: left;
    }
    .add-btn-container .add-btn {
        background-color: transparent;
        font-size: 14px;
        border: none;
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }

    .misc-content {
        max-height: 2.5em;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .more-btn {
        display: none;
        background-color: transparent;
        border: none;
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }

    .misc-cell {
        position: relative;
    }

    .misc-cell .more-btn {
        position: absolute;
        right: 5px;
        bottom: 5px;
    }

    .overlay-dark-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1999;
        display: none;
    }

    .misc-overlay {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        width: 50%;
        height: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border: 1px solid black;
        padding: 20px;
        z-index: 2000;
        overflow-y: auto;
        user-select: text;
    }

    .misc-overlay .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }

    .misc-overlay-content {
        font-size: 14px;
        width: 700px;
        position: relative;
        padding-top: 30px;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .tag-overlay {
        display: none;
        position: absolute;
        background-color: white;
        border: 1px solid black;
        padding: 20px;
        z-index: 1001;
        font-family: Arial, sans-serif;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
    }

    .tag-overlay .close-btn {
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }

    .tag-overlay-content {
        position: relative;
        padding: 20px;
        border-radius: 5px;
        background-color: white;
        text-align: left;
        font-family: Arial, sans-serif;
        font-size: 12px;
    }

    .tag-overlay-input-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .tag-overlay-input-group label {
        flex: 1;
        text-align: right;
        margin-right: 10px;
    }

    .tag-overlay-input-group input {
        flex: 2;
    }

    .tag-overlay-button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .nlb-name {
        text-align: left;
        font-size: 13px;
        font-weight: bold;
    }

    .nlb-system-id {
        display: block;
        font-size: 12px;
        font-weight: normal;
        color: #666;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
    }

    .system-id-overlay {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50%;
        max-width: 600px;
        background-color: white;
        border: 1px solid black;
        padding: 20px;
        z-index: 2000;
        border-radius: 5px;
    }

    .system-id-overlay-content {
        position: relative;
        font-family: Arial, sans-serif;
        font-size: 14px;
        word-wrap: break-word;
    }

    .system-id-overlay .close-btn {
        position: absolute;
        top: -15px;
        right: -5px;
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }

    .copy-btn {
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
        margin-left: 10px;
    }

    .nlb-name .nlb-created-time {
        display: block;
        font-size: 12px;
        font-weight: normal;
        color: #666;
    }

    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .form-group label {
        flex: 1;
        text-align: right;
        margin-right: 10px;
    }
    .form-group input, .form-group textarea, .form-group select {
        flex: 2;
    }
    .form-group .tag-inputs {
        display: flex;
        flex: 2;
        margin-left: 10px;
    }
    .form-group .tag-inputs input {
        flex: 1;
        margin-right: 5px;
    }
    .form-group button {
        margin-left: 10px;
    }
    
    .form-group-tags {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .form-group-tags label {
        flex: 1;
        text-align: right;
        margin-left: 6px;
        margin-right: 2px;
    }
    .form-group-tags input {
        flex: 2;
    }

    .tag-input-group {
        display: flex;
        align-items: center;
        flex: 2;
    }
    .tag-input-group input {
        width: 60px;
        flex: 0.5;
        margin-right: 5px;
    }
    .tag-input-group button {
        margin-left: 5px;
    }
    .nlb-tag-key {
        margin-left: 10px;
    }

    #nlb-tag-container {
        display: flex;
        flex-direction: column;
    }

    .vm-input {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }

    .vm-input input {
        width: 80%;
        padding: 5px;
        margin-right: 10px;
    }

    .vm-input button {
        padding: 5px 10px;
        cursor: pointer;
    }
    .header-with-progress {
        display: flex;
        align-items: center;
        margin-bottom: 0px;
    }
    .progress-bar-container {
        width: 600px;
        margin-left: 10px;
        margin-bottom: 10px;
        height: 22px;
        background-color: #f0f5ff;
        border-radius: 4px;
        overflow: hidden;
        display: none;
        position: relative;
        z-index: 2000;
    }
    .progress-bar {
        width: 0;
        height: 100%;
        background-color: #cce6ff;
        border-radius: 4px;
        transition: width 3s ease;
    }
    #timeDisplay {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        font-size: 14px;
        color: #333;
        z-index: 30;
    }

    /* Error Modal Styling */
    #errorModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    #errorModal .overlay-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: left;
        font-family: Arial, sans-serif;
        font-size: 14px;
        max-width: 500px;
        width: 80%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }

    #errorModal button {
        margin-top: 15px;
        padding: 5px 10px;
        cursor: pointer;
    }

    .nlb-health-info-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .nlb-health-info-overlay-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: left;
        width: 80%;
        max-width: 600px;
        overflow-y: auto;
        position: relative;
    }

    .nlb-health-info-overlay-content .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }

    button.check-btn {
        background-color: #a3d2f9;
        border: none;
        color: rgb(0, 0, 255);
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button.check-btn:hover {
        background-color: #82b8e6;
    }

    .checkbox-wrapper {
        display: block;
        margin-right: 0px; 
    }

    .checkbox-wrapper input[type="checkbox"] {
        margin-right: 5px;
    }

    #vmContainer, #addVMContainer {
        border: 1px solid black;
        padding: 10px;
        width: 60%;
        overflow-y: auto;
        margin: 0 auto;
        white-space: normal;
    }

</style>
</head>
<body>
    <div class="fixed-header">
        <div class="header-container">
            <img src="/spider/adminweb/images/left-menu/nlb.png" alt="NLB Icon">
            <h1>NLB Management</h1>
            <div class="searchContainer">
                <input type="text" id="searchInput" onkeyup="searchKeyword()" placeholder="Search Keyword...">
                <button id="clearSearch" onclick="clearSearchInput()">X</button>
            </div>
        </div>        
        <div class="fixed-action-buttons">
            <input type="checkbox" onclick="toggleSelectAll(this)">
            <button onclick="deleteSelectedNLBs()">Delete</button>
        </div>
    </div>
    
    <div class="content">
        <div class="header-with-progress">
            <button class="add-button" onclick="showOverlay()">+</button>
            <div id="mockButtonsContainer" style="display: flex; align-items: center;"></div>
            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar" id="progressBar"></div>
                <span id="timeDisplay"></span>
            </div>  
        </div>
        <table id="nlb-table">
            <tr>
                <th class="column-num">#</th>
                <th class="nlb-name" style="text-align: center;">Name</th>
                <th class="vpc-name">VPC Name</th>
                <th class="scope-type">Scope | Type</th>
                <th class="listener">Listener</th>
                <th class="vm-groups">VM Groups</th>
                <th class="health-checker">Health Checker</th>
                <th class="tags">Tags</th>
                <th class="misc">Misc</th>
                <th class="checkbox-cell"><input type="checkbox" onclick="toggleSelectAll(this)"></th>
            </tr>
            {{range $index, $nlb := .NLBs}}
            <tr>
                <td class="column-num">{{$index | inc}}</td>
                <td class="nlb-name">
                    {{$nlb.IId.NameId}}
                    <span class="nlb-system-id" onclick="showSystemIdOverlay('{{$nlb.IId.SystemId}}')">&nbsp;• {{$nlb.IId.SystemId}}</span>
                    <span class="nlb-created-time" data-time="{{ $nlb.CreatedTime }}"></span>
                </td>
                <td class="nlb-name vpc-name">
                    {{if $nlb.VpcIID.NameId}}
                        {{$nlb.VpcIID.NameId}}
                        <span class="nlb-system-id" onclick="showSystemIdOverlay('{{$nlb.VpcIID.SystemId}}')">&nbsp;• {{$nlb.VpcIID.SystemId}}</span>
                    {{end}}
                </td>
                <td class="scope-type">
                    {{if $nlb.VpcIID.NameId}}
                        {{$nlb.Scope}} | {{$nlb.Type}}
                    {{end}}
                </td>
                
                <!-- Listener -->
                <td class="listener">
                    {{if $nlb.VpcIID.NameId}}
                        <table class="inner-table">
                            <tr>
                                <th>Protocol</th>
                                <td>{{$nlb.Listener.Protocol}}</td>
                            </tr>
                            <tr>
                                <th>Port</th>
                                <td>{{$nlb.Listener.Port}}</td>
                            </tr>
                            <tr>
                                <th>Public IP</th>
                                <td>{{$nlb.Listener.IP}}</td>
                            </tr>
                            <tr>
                                <th>DNS</th>
                                <td>{{$nlb.Listener.DNSName}}</td>
                            </tr>
                            <tr>
                                <th>Status</th>
                                <td>
                                    <button class="check-btn" 
                                            onclick="checkNLBListener('{{$nlb.Listener.Protocol}}', '{{$nlb.Listener.Port}}', '{{$nlb.Listener.IP}}', '{{$nlb.Listener.DNSName}}')" 
                                            style="font-size: 11px; padding: 4px 8px;">
                                        Check
                                    </button>
                                </td>
                            </tr>
                        </table>
                    {{end}}
                </td>
                                
                <!-- VM Groups -->
                <td class="vm-groups">
                    {{if $nlb.VpcIID.NameId}}
                        <table class="inner-table">
                            <tr>
                                <th>Protocol</th>
                                <td>{{$nlb.VMGroup.Protocol}}</td>
                            </tr>
                            <tr>
                                <th>Port</th>
                                <td>{{$nlb.VMGroup.Port}}</td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <div style="display: flex; justify-content: center; align-items: center; position: relative;">
                                        <span style="font-weight: bold; margin-right: auto; text-align: center; width: 100%;">VMs</span>
                                        <div style="position: absolute; right: 0; padding-right: 3%">
                                            <button class="vm-add" style="padding: 1px 5px; font-size: 12px;" onclick="showVMOverlay('{{$nlb.IId.NameId}}', extractNames('{{$nlb.VMGroup.VMs}}'))">add</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <table class="inner-table vm-list">
                                        {{range $vm := $nlb.VMGroup.VMs}}
                                        <tr>
                                            <td style="text-align: center;">{{$vm.NameId}}</td>
                                            <td style="background-color: white; width: 10%;">
                                                <button id="vm-del" style="padding: 1px 5px; font-size: 12px; font-size: 12px;" onclick="delVMFromNLB('{{$nlb.IId.NameId}}', '{{$vm.NameId}}')">del</button>
                                            </td>
                                        </tr>
                                        {{end}}
                                    </table>
                                </td>
                            </tr>
                        </table>
                    {{end}}
                </td>

                
                <!-- Health Checker -->
                <td class="health-checker">
                    {{if $nlb.VpcIID.NameId}}
                        <table class="inner-table-health">
                            <tr>
                                <th>Protocol</th>
                                <td>{{$nlb.HealthChecker.Protocol}}</td>
                            </tr>
                            <tr>
                                <th>Port</th>
                                <td>{{$nlb.HealthChecker.Port}}</td>
                            </tr>
                            <tr>
                                <th>Interval</th>
                                <td>{{$nlb.HealthChecker.Interval}}</td>
                            </tr>
                            <tr>
                                <th>Timeout</th>
                                <td>{{$nlb.HealthChecker.Timeout}}</td>
                            </tr>
                            <tr>
                                <th>Threshold</th>
                                <td>{{$nlb.HealthChecker.Threshold}}</td>
                            </tr>
                            <tr>
                                <th>Status</th>
                                <td>
                                    <button class="check-btn" onclick="checkNLBHealth('{{$nlb.IId.NameId}}')" style="font-size: 11px; padding: 4px 8px;">Check</button>
                                </td>
                            </tr>
                        </table>
                    {{end}}
                </td>                
                
                <td class="tags" style="text-align: left;">
                    {{if $nlb.VpcIID.NameId}}
                        {{range $tag := $nlb.TagList}}
                        <div class="tag-container" onclick="showTagOverlay(event, '{{$tag.Key}}: {{$tag.Value}}', 'NLB', '{{$nlb.IId.NameId}}')">{{$tag.Key}}: {{$tag.Value}}</div>
                        {{end}}
                        <div class="add-btn-container">
                            <button class="add-btn" onclick="showAddTagOverlay('{{$nlb.IId.NameId}}')">+</button>
                        </div>
                    {{end}}
                </td>
                
                <td class="misc misc-cell">
                    <div class="misc-content">{{range $kv := $nlb.KeyValueList}}{{$kv.Key}} : {{$kv.Value}}<br>{{end}}</div>
                    <button class="more-btn" onclick="showMiscOverlay(this)">more...</button>
                </td>
                <td class="checkbox-cell center-align">
                    <input type="checkbox" name="deleteCheckbox" value="{{$nlb.IId.NameId}}">
                </td>
            </tr>
            {{end}}
            {{if not .NLBs}}
            <tr>
                <td colspan="11" class="center-align">No NLBs found for this connection.</td>
            </tr>
            {{end}}
        </table>  
    </div>

    <!-- Overlay: Add New NLB -->
    <div id="overlay" class="overlay">
        <div class="overlay-content">
            <h2>Add New NLB</h2>
            <form id="addNLBForm" onsubmit="event.preventDefault(); postNLB();">
                <input type="hidden" id="connConfig" value="{{.ConnectionConfig}}">                
                <h3>NLB Info:</h3>
                <div class="form-group">
                    <label for="nlbName">Name:</label>
                    <input type="text" id="nlbName" name="nlbName" required style="width: 65%;">
                </div>
                <div class="form-group">
                    <label for="vpcName">VPC Name:</label>
                    <select id="vpcName" name="vpcName" required style="width: 65%;"></select>
                </div>
                <div class="form-group">
                    <label for="type">Type:</label>
                    <select id="type" name="type" required style="background-color: #E6E6FA; width: 65%;">
                        <option value="PUBLIC">PUBLIC</option>
                        <option value="INTERNAL">INTERNAL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="scope">Scope:</label>
                    <select id="scope" name="scope" required style="background-color: #F5F5DC; width: 65%;">
                        <option value="REGION">REGION</option>
                        <option value="GLOBAL">GLOBAL</option>
                    </select>
                </div>
    
                <div style="margin-top: 20px;"></div>
                <h3>Listener:</h3>
                <div class="form-group">
                    <label for="protocol">Protocol:</label>
                    <select id="protocol" name="protocol" required style="background-color: #E6E6FA; width: 65%;">
                        <option value="TCP">TCP</option>
                        <option value="UDP">UDP</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="port">Port:</label>
                    <input type="number" id="port" name="port" required min="1" max="65535" value="22" style="background-color: #F5F5DC; width: 70%;" onchange="if(this.value<1)this.value=1;if(this.value>65535)this.value=65535;">
                </div>
    
                <div style="margin-top: 20px;"></div>
                <h3>VM Groups:</h3>
                <div class="form-group">
                    <label for="vmProtocol">Protocol:</label>
                    <select id="vmProtocol" name="vmProtocol" required style="background-color: #E6E6FA; width: 65%;">
                        <option value="TCP">TCP</option>
                        <option value="UDP">UDP</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vmPort">Port:</label>
                    <input type="number" id="vmPort" name="vmPort" required min="1" max="65535" value="22" style="background-color: #F5F5DC; width: 70%;" onchange="if(this.value<1)this.value=1;if(this.value>65535)this.value=65535;">
                </div>
                <div class="form-group">
                    <label for="vmContainer">VMs:</label>
                    <div id="vmContainer" name="vmContainer"></div>                        
                </div>
    
                <div style="margin-top: 20px;"></div>
                <h3>Health Checker:</h3>
                <div class="form-group">
                    <label for="hcProtocol">Protocol:</label>
                    <select id="hcProtocol" name="hcProtocol" required style="background-color: #E6E6FA; width: 65%;">
                        <option value="TCP">TCP</option>
                        <option value="HTTP">HTTP</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hcPort">Port:</label>
                    <input type="number" id="hcPort" name="hcPort" required min="1" max="65535" value="22" style="background-color: #F5F5DC; width: 70%;" onchange="if(this.value<1)this.value=1;if(this.value>65535)this.value=65535;">
                </div>
                <div class="form-group-tags">
                    <label for="interval">Interval:</label>
                    <input type="text" id="interval" name="interval" value="default" style="width: 43px;">

                    <label for="timeout">Timeout:</label>
                    <input type="text" id="timeout" name="timeout" value="default" style="width: 43px;">

                    <label for="threshold">Threshold:</label>
                    <input type="text" id="threshold" name="threshold" value="default" style="width: 43px;">
                </div>
                <div class="form-group">
                    <h3>Tags:</h3>
                    <div id="nlb-tag-container"></div>
                    <button type="button" onclick="addNLBTagField()">+</button>
                </div>    
                <div class="form-group" style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                    <button type="submit">Add NLB</button>
                    <button type="button" onclick="hideOverlay('overlay')" style="margin-left: 10px;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="tag-overlay" class="tag-overlay">
        <div class="tag-overlay-content"></div>
    </div>
    
    <!-- Add Tag Overlay -->
    <div id="add-tag-overlay" class="overlay">
        <div class="add-tag-overlay-content overlay-content"></div>
    </div>

    <!-- Add VM Overlay -->
    <div id="vmOverlay" class="overlay" style="display: none;">
        <div class="overlay-content">
            <h2>Add VM</h2>
            <form id="addVMForm" onsubmit="event.preventDefault(); addVMToNLB();">
                <div class="form-group">
                    <label for="addVmContainer">VMs:</label>
                    <div id="addVMContainer" name="addVmContainer"></div>                        
                </div>
                <div class="form-group" style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                    <button type="submit">Add VM</button>
                    <button type="button" onclick="hideOverlay('vmOverlay')" style="margin-left: 10px;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="overlay">
        <div class="overlay-content">
            <h2 id="errorTitle">Error</h2>
            <p id="errorMessage"></p>
            <button onclick="closeErrorModal()">Close</button>
        </div>
    </div>

    <!-- NLB Health Info Overlay -->
    <div id="nlbHealthOverlay" class="nlb-health-info-overlay">
        <div class="nlb-health-info-overlay-content">
            <button class="close-btn" onclick="closeNLBHealthOverlay()">x</button>
            <h2>NLB Health Information</h2>
            <div id="nlbHealthDetails">
                <!-- Dynamic health details will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Listener Check Info Overlay -->
    <div id="listenerCheckOverlay" class="nlb-health-info-overlay">
        <div class="nlb-health-info-overlay-content">
            <button class="close-btn" onclick="closeListenerCheckOverlay()">x</button>
            <h2>NLB Listener Check Status</h2>
            <div id="listenerCheckDetails">
                <!-- Dynamic listener check details will be inserted here -->
            </div>
        </div>
    </div>

    <div id="system-id-overlay" class="system-id-overlay">
        <div class="system-id-overlay-content">
            <button class="close-btn" onclick="closeSystemIdOverlay()">x</button>
            <h2>System ID (Managed by CSP)</h2>
            <p id="fullSystemId"></p>
            <button class="copy-btn" onclick="copySystemId()">📋</button>
        </div>
    </div>

</body>
    
<script>
    function searchKeyword() {
        let input = document.getElementById('searchInput');
        let filter = input.value.toUpperCase().trim();

        if (!filter) {
            clearSearchInput();
            return;
        }

        let table = document.getElementById('nlb-table');
        let tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            let tds = tr[i].getElementsByTagName('td');
            let rowVisible = false;

            for (let j = 0; j < tds.length; j++) {
                let td = tds[j];
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        td.classList.add('highlight');
                        rowVisible = true;
                    } else {
                        td.classList.remove('highlight');
                    }
                }
            }
        }
    }

    function clearSearchInput() {
        let input = document.getElementById('searchInput');
        input.value = '';

        let table = document.getElementById('nlb-table');
        let tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            tr[i].style.display = '';
            let tds = tr[i].getElementsByTagName('td');
            for (let j = 0; j < tds.length; j++) {
                tds[j].classList.remove('highlight');
            }
        }
    }

    let currentProvider = '';

    function showError(message, title) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        const formattedMessage = message.split('.').join('.<br>');
        errorDiv.innerHTML = `<p>${title}</p><p>${formattedMessage}</p><button onclick="closeError()">OK</button>`;
        document.body.appendChild(errorDiv);
        document.addEventListener('keydown', handleEscError);
    }

    function closeError() {
        const errorDiv = document.querySelector('.error-message');
        if (errorDiv) {
            errorDiv.remove();
            document.removeEventListener('keydown', handleEscError);
        }
    }

    function handleEscError(event) {
        if (event.key === "Escape") {
            closeError();
        }
    }

    function fetchWithProgress(url, options) {
        showProgressBar();

        const startTime = Date.now();
        const timerInterval = 500;
        let timerId = setInterval(() => {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const timeDisplay = document.getElementById('timeDisplay');
            timeDisplay.textContent = `${(Math.floor(elapsedTime * 2) / 2).toFixed(1)}s`;
        }, timerInterval);

        return fetch(url, options)
            .then(response => {
                clearInterval(timerId);
                hideProgressBar();
                return response;
            })
            .catch(error => {
                clearInterval(timerId);
                hideProgressBar();
                throw error;
            });
    }

    function showProgressBar() {
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';
        progressBarContainer.style.display = 'block';

        setTimeout(() => {
            progressBar.style.width = '100%';
        }, 100);
    }

    function hideProgressBar() {
        const progressBarContainer = document.getElementById('progressBarContainer');
        setTimeout(() => {
            progressBarContainer.style.display = 'none';
            document.getElementById('timeDisplay').textContent = '';
        }, 500);
    }

    function deleteSelectedNLBs() {
        const connConfig = document.getElementById('connConfig').value;
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]:checked');
        if (checkboxes.length === 0) {
            alert("Please select NLBs to delete.");
            return;
        }

        if (!confirm("Are you sure you want to delete the selected NLBs?")) {
            return;
        }

        const deletePromises = Array.from(checkboxes).map(checkbox => {
            const nlbName = checkbox.value;
            const data = {
                ConnectionName: connConfig
            };

            return fetchWithProgress(`/spider/nlb/${nlbName}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.message);
                    });
                }
                return response.json();
            });
        });

        Promise.all(deletePromises)
            .then(() => location.reload())
            .catch(error => {
                alert("Error deleting NLBs: " + error.message);
        });
    }

    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]');
        for (const checkbox of checkboxes) {
            checkbox.checked = source.checked;
        }
    }

    function validateForm() {
        const nlbName = document.getElementById('nlbName').value.trim();
        const vpcName = document.getElementById('vpcName').value.trim();
        const protocol = document.getElementById('protocol').value.trim();
        const port = document.getElementById('port').value.trim();

        if (!nlbName || !vpcName || !protocol || !port) {
            alert("Please fill in all the fields.");
            return false;
        }

        const vms = Array.from(document.querySelectorAll('#vmContainer input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);
                        
        if (vms.length === 0) {
            alert("Please select at least one VM.");
            return false;
        }

        return true;
    }

    function postNLB() {
        if (!validateForm()) {
            return;
        }
        console.log("POSTNLB");
        const connConfig = document.getElementById('connConfig').value;
        const nlbName = String(document.getElementById('nlbName').value);
        const vpcName = document.getElementById('vpcName').value;
        const type = document.getElementById('type').value;
        const scope = document.getElementById('scope').value;
        const protocol = document.getElementById('protocol').value;
        const port = document.getElementById('port').value;
        const vmProtocol = document.getElementById('vmProtocol').value;
        const vmPort = document.getElementById('vmPort').value;
        const vms = Array.from(document.querySelectorAll('#vmContainer input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
        const hcProtocol = document.getElementById('hcProtocol').value;
        const hcPort = document.getElementById('hcPort').value;
        const interval = document.getElementById('interval').value;
        const timeout = document.getElementById('timeout').value;
        const threshold = document.getElementById('threshold').value;

        const tags = Array.from(document.querySelectorAll('.nlb-tag-input')).map(tagInput => ({
            Key: tagInput.querySelector('.nlb-tag-key').value,
            Value: tagInput.querySelector('.nlb-tag-value').value
        }));

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                Name: nlbName,
                VPCName: vpcName,
                Type: type,
                Scope: scope,
                Listener: {
                    Protocol: protocol,
                    Port: port
                },
                VMGroup: {
                    Protocol: vmProtocol,
                    Port: vmPort,
                    VMs: vms
                },
                HealthChecker: {
                    Protocol: hcProtocol,
                    Port: hcPort,
                    Interval: interval,
                    Timeout: timeout,
                    Threshold: threshold
                },
                TagList: tags
            }
        };

        fetchWithProgress('/spider/nlb', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        }).then(() => {
            location.reload();
        }).catch(error => {
            showErrorModal("NLB Creation Error", `Error creating NLB: ${error.message}`);
        });
    }

    function showErrorModal(title, message) {
        document.getElementById('errorTitle').textContent = title;
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorModal').style.display = 'flex';
    }

    function closeErrorModal() {
        document.getElementById('errorModal').style.display = 'none';
    }

    function showOverlay() {
        Promise.all([loadVPCs(), loadVMs('vmContainer')])
            .then(() => {
                const region = '{{.RegionName}}';
                const nlbNameInput = document.getElementById('nlbName');

                nlbNameInput.value = `${region}-nlb-${Math.random().toString(36).substring(2, 5)}`;
                document.getElementById('protocol').value = 'TCP';
                document.getElementById('port').value = '22';

                document.getElementById('overlay').style.display = 'flex'; 
                document.addEventListener('keydown', handleEsc);
                clearFormFields();
            })
            .catch(error => {
                console.error('Error loading VPCs or VMs:', error);
            });
    }

    function clearFormFields() {
        const region = '{{.RegionName}}';
        const nlbNameInput = document.getElementById('nlbName');
        
        // Reset NLB information
        nlbNameInput.value = `${region}-nlb-${Math.random().toString(36).substring(2, 5)}`;
        document.getElementById('protocol').value = 'TCP';
        document.getElementById('port').value = '22';
        
        // Reset VPC and VM group
        document.getElementById('vpcName').selectedIndex = 0;
        document.getElementById('vmProtocol').value = 'TCP';
        document.getElementById('vmPort').value = '22';

        // Reset Health Checker information
        document.getElementById('hcProtocol').value = 'TCP';
        document.getElementById('hcPort').value = '22';

        var provider = '{{.ProviderName}}';
        if (provider === 'IBM') {
            document.getElementById('interval').value = '10';
            document.getElementById('timeout').value = '9';
            document.getElementById('threshold').value = 'default';
        } else {
            document.getElementById('interval').value = 'default';
            document.getElementById('timeout').value = 'default';
            document.getElementById('threshold').value = 'default';
        }

        // Reset VM list
        document.getElementById('vmContainer').innerHTML = ''; 

        // Reset tag fields
        document.querySelectorAll('.nlb-tag-input').forEach(tagInput => tagInput.remove());
    }

    function extractNames(vmString) {
        return vmString.match(/\{([^ ]+)/g).map(match => match.replace("{", ""));
    }

    let currnetNLBName = ""
    function showVMOverlay(nlbName, vmGroups) {
        loadVMsExceptExist('addVMContainer', vmGroups);
        currnetNLBName = nlbName;
        document.getElementById('vmOverlay').style.display = 'flex';
    }

    function hideOverlay(pos) {
        document.getElementById(pos).style.display = 'none';
        document.removeEventListener('keydown', handleEsc);
        clearFormFields();
    }

    function handleEsc(event) {
        if (event.key === "Escape") {
            hideOverlay();
        }
    }

    function checkNLBHealth(nlbName) {
        const connConfig = document.getElementById('connConfig').value;

        // Fetch NLB health info from server
        fetchWithProgress(`/spider/nlb/${nlbName}/health?ConnectionName=${connConfig}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
        .then(data => {
            const healthInfo = data.healthinfo;
            const allVMs = healthInfo.AllVMs || [];
            const healthyVMs = healthInfo.HealthyVMs || [];
            const unhealthyVMs = healthInfo.UnHealthyVMs || [];

            // Generate table rows for all VMs
            let allVMsTableRows = allVMs.map(vm => `
                <tr>
                    <td>${vm.NameId}</td>
                    <td>${vm.SystemId}</td>
                </tr>
            `).join('');

            // Generate table rows for healthy VMs
            let healthyVMsTableRows = healthyVMs.length > 0 ? 
            healthyVMs.map(vm => `
                <tr>
                    <td>${vm.NameId}</td>
                    <td>${vm.SystemId}</td>
                </tr>
            `).join('') : '<tr><td colspan="2">No healthy VMs</td></tr>';

            // Generate table rows for unhealthy VMs
            let unhealthyVMsTableRows = unhealthyVMs.length > 0 ? 
                unhealthyVMs.map(vm => `
                    <tr>
                        <td>${vm.NameId}</td>
                        <td>${vm.SystemId}</td>
                    </tr>
                `).join('') : '<tr><td colspan="2">No unhealthy VMs</td></tr>';

            // HTML for the overlay content with tables
            const nlbHealthDetails = `
                <br>

                <h3>All VMs (${allVMs.length})</h3>
                <table border="1" cellpadding="5" cellspacing="0">
                    <thead>
                        <tr>
                            <th>NameId</th>
                            <th>SystemId</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allVMsTableRows}
                    </tbody>
                </table>

                <h3 style="color: rgb(0,0,255);">Healthy VMs (${healthyVMs.length})</h3>
                <table border="1" cellpadding="5" cellspacing="0">
                    <thead>
                        <tr>
                            <th>NameId</th>
                            <th>SystemId</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${healthyVMsTableRows}
                    </tbody>
                </table>

                <h3 style="color: #f08080;">Unhealthy VMs (${unhealthyVMs.length})</h3>
                <table border="1" cellpadding="5" cellspacing="0">
                    <thead>
                        <tr>
                            <th>NameId</th>
                            <th>SystemId</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${unhealthyVMsTableRows}
                    </tbody>
                </table>
            `;

            // Update the overlay content
            document.getElementById('nlbHealthDetails').innerHTML = nlbHealthDetails;

            // Show the overlay
            document.getElementById('nlbHealthOverlay').style.display = 'flex';
        }).catch(error => {
            showError("Error fetching NLB health info: " + error.message, "NLB Health Info Error");
        });
    }

    function closeNLBHealthOverlay() {
        document.getElementById('nlbHealthOverlay').style.display = 'none';
    }

    function checkNLBListener(protocol, port, ip, dnsName) {
        const connConfig = document.getElementById('connConfig').value;
        const hostName = ip ? ip : dnsName;
        const url = `/spider/check/${protocol.toLowerCase()}?HostName=${hostName}&Port=${port}`;

        // Fetch Listener status from server
        fetchWithProgress(url, {
            method: 'GET',
            headers: {
                'accept': 'application/json'
            }
        }).then(response => response.json())
        .then(data => {
            const message = data.message;

            // HTML for the overlay content with tables
            const listenerCheckDetails = `                
                <table border="1" cellpadding="5" cellspacing="0" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 30%; text-align: right;">Attribute</th>
                            <th style="width: 70%;">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: right;"><strong>Protocol</strong></td>
                            <td>${protocol}</td>
                        </tr>
                        <tr>
                            <td style="text-align: right;"><strong>Port</strong></td>
                            <td>${port}</td>
                        </tr>
                        <tr>
                            <td style="text-align: right;"><strong>HostName</strong></td>
                            <td>${hostName}</td>
                        </tr>
                        <tr>
                            <td style="text-align: right;"><strong>Status</strong></td>
                            <td>
                                ${getStatusHTML(message, protocol)}
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;

            // Update the overlay content
            document.getElementById('listenerCheckDetails').innerHTML = listenerCheckDetails;

            // Show the overlay
            document.getElementById('listenerCheckOverlay').style.display = 'flex';
        }).catch(error => {
            showError("Error checking listener status: " + error.message, "Listener Check Error");
        });
    }

    function closeListenerCheckOverlay() {
        document.getElementById('listenerCheckOverlay').style.display = 'none';
    }


    function loadVPCs() {
        const connConfig = document.getElementById('connConfig').value;
        const url = `/spider/vpc?ConnectionName=${encodeURIComponent(connConfig)}`;

        fetchWithProgress(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const vpcSelect = document.getElementById('vpcName');
            vpcSelect.innerHTML = '';
            if (data.vpc.length > 0) {
                data.vpc.forEach((vpc, index) => {
                    const option = document.createElement('option');
                    option.value = vpc.IId.NameId;
                    option.text = `${vpc.IId.NameId} (${vpc.IPv4_CIDR})`;
                    vpcSelect.appendChild(option);
                    if (index === 0) {
                        vpcSelect.value = vpc.IId.NameId;
                    }
                });
            } else {
                const option = document.createElement('option');
                option.value = "";
                option.text = "No VPCs. Create one.";
                vpcSelect.appendChild(option);
                vpcSelect.disabled = true;
            }
        })
        .catch(error => {
            console.error('Error loading VPCs:', error);
            showError("Error loading VPCs: " + error.message, "VPC Load Error");
        });
    }

    function addNLBTagField() {
        const tagContainer = document.getElementById('nlb-tag-container');
        const tagInput = document.createElement('div');
        tagInput.className = 'nlb-tag-input tag-input-group';
        tagInput.innerHTML = `
            <input type="text" class="nlb-tag-key" placeholder="Key" required>
            <input type="text" class="nlb-tag-value" placeholder="Value" required>
            <button type="button" onclick="removeTagField(this)">-</button>
        `;
        tagContainer.appendChild(tagInput);
    }


    function removeTagField(button) {
        button.parentElement.remove();
    }


    function showMiscOverlay(button) {
        const miscContent = button.previousElementSibling.innerHTML;
        const overlayDarkBackground = document.createElement('div');
        overlayDarkBackground.className = 'overlay-dark-background';
        document.body.appendChild(overlayDarkBackground);

        const overlay = document.createElement('div');
        overlay.className = 'misc-overlay';
        overlay.innerHTML = `
            <button class="close-btn">x</button>
            <div class="misc-overlay-content" tabindex="0">${miscContent}</div>
        `;

        document.body.appendChild(overlay);
        overlayDarkBackground.style.display = 'block';
        overlay.style.display = 'block';

        const overlayContent = overlay.querySelector('.misc-overlay-content');
        overlayContent.focus();

        document.addEventListener('keydown', handleEscKey);
        overlayDarkBackground.addEventListener('click', handleClickOutside);
        overlay.querySelector('.close-btn').addEventListener('click', closeMiscOverlay);

        function closeMiscOverlay() {
            if (overlay) overlay.remove();
            if (overlayDarkBackground) overlayDarkBackground.remove();
            document.removeEventListener('keydown', handleEscKey);
            overlayDarkBackground.removeEventListener('click', handleClickOutside);
        }

        function handleEscKey(event) {
            if (event.key === 'Escape') {
                closeMiscOverlay();
            }
        }

        function handleClickOutside(event) {
            if (event.target === overlayDarkBackground) {
                closeMiscOverlay();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const miscCells = document.querySelectorAll('.misc-cell');

        miscCells.forEach(cell => {
            const content = cell.querySelector('.misc-content');
            const button = cell.querySelector('.more-btn');

            if (content.scrollHeight > content.clientHeight) {
                button.style.display = 'inline-block';
            } else {
                button.style.display = 'none';
            }
        });
    });


    function showTagOverlay(event, tag, resourceType, resourceName) {
        event.stopPropagation();
        const tagOverlay = document.getElementById('tag-overlay');
        const tagOverlayContent = document.querySelector('.tag-overlay-content');
        tagOverlayContent.innerHTML = `
            <button class="close-btn" onclick="closeTagOverlay()">x</button>
            <p>${tag}</p>
            <div class="button-group">
                <button onclick="deleteTag('${tag}', '${resourceType}', '${resourceName}')">Delete</button>
                <button onclick="closeTagOverlay()">Cancel</button>
            </div>
        `;
        tagOverlay.style.display = 'block';
        tagOverlay.style.top = `${event.clientY}px`;
        tagOverlay.style.left = `${event.clientX}px`;
        document.addEventListener('click', handleClickOutsideOverlay);
        document.addEventListener('keydown', handleEscTagOverlay);
    }

    function deleteTag(tag, resourceType, resourceName) {
        const connConfig = document.getElementById('connConfig').value;
        const [tagKey, tagValue] = tag.split(': ');

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                ResourceType: resourceType.trim(),
                ResourceName: resourceName.trim()
            }
        };

        fetchWithProgress(`/spider/tag/${tagKey.trim()}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        }).then(() => {
            closeTagOverlay();
            location.reload();
        }).catch(error => {
            showError("Error deleting tag: " + error.message, "Resource Name: " + resourceName);
        });
    }

    function closeTagOverlay() {
        const tagOverlay = document.getElementById('tag-overlay');
        tagOverlay.style.display = 'none';
        document.removeEventListener('click', handleClickOutsideOverlay);
        document.removeEventListener('keydown', handleEscTagOverlay);
    }

    function handleEscTagOverlay(event) {
        if (event.key === "Escape") {
            closeTagOverlay();
        }
    }

    function handleClickOutsideOverlay(event) {
        const tagOverlay = document.getElementById('tag-overlay');
        if (!tagOverlay.contains(event.target)) {
            closeTagOverlay();
        }
    }

    function showAddTagOverlay(nlbName) {
        const addTagOverlay = document.getElementById('add-tag-overlay');
        const addTagOverlayContent = document.querySelector('.add-tag-overlay-content');
        addTagOverlayContent.innerHTML = `
            <div class="tag-overlay-input-group">
                <label for="tagOverlayTagKey">Tag Key:</label>
                <input type="text" id="tagOverlayTagKey" name="tagKey" required>
            </div>
            <div class="tag-overlay-input-group">
                <label for="tagOverlayTagValue">Tag Value:</label>
                <input type="text" id="tagOverlayTagValue" name="tagValue" required>
            </div>
            <div class="tag-overlay-button-group">
                <button onclick="addTag('${nlbName}')">Add</button>
                <button onclick="closeAddTagOverlay()">Cancel</button>
            </div>
        `;
        addTagOverlay.style.display = 'flex';
        document.addEventListener('keydown', handleEscAddTagOverlay);
    }

    function closeAddTagOverlay() {
        const addTagOverlay = document.getElementById('add-tag-overlay');
        addTagOverlay.style.display = 'none';
        document.removeEventListener('keydown', handleEscAddTagOverlay);
    }


    function handleEscAddTagOverlay(event) {
        if (event.key === "Escape") {
            closeAddTagOverlay();
        }
    }

    function addTag(nlbName) {
        const tagKey = document.getElementById('tagOverlayTagKey').value;
        const tagValue = document.getElementById('tagOverlayTagValue').value;
        const connConfig = document.getElementById('connConfig').value;
        if (!tagKey) {
            alert("Please enter Tag Key.");
            return;
        }

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                ResourceType: 'NLB',
                ResourceName: nlbName,
                Tag: { Key: tagKey, Value: tagValue }
            }
        };
        fetchWithProgress('/spider/tag', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {              
            if (!response.ok) {                    
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        }).then(() => {                
            closeAddTagOverlay();
            location.reload();
        }).catch(error => {
            showError("Error adding tag: " + error.message, "NLB Name: " + nlbName);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const timeElements = document.querySelectorAll('.nlb-created-time');

        timeElements.forEach(function(element) {
            const originalTime = element.getAttribute('data-time');
            const formattedTime = formatTime(originalTime);
            element.innerHTML = '&nbsp;• ' + formattedTime;
        });

        function formatTime(originalTime) {
            const parts = originalTime.split(" ");
            const date = parts[0];
            const time = parts[1].slice(0, 5);
            const timezone = parts[3];
            return `${date} ${time} ${timezone}`;
        }
    });

    function addVMToNLB(){
        const selectedVMs = getSelectedVMs();
        const url = `/spider/nlb/${currnetNLBName}/vms`;

        if(selectedVMs.length === 0){
            alert("Please Select at Least One VM.");
            return;
        }

        const requestBody = {
            ConnectionName: '{{.ConnectionConfig}}',
            ReqInfo:{
                VMs: selectedVMs
            }
        };

        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            if(!response.ok){
                throw new Error(`ADD VM ERROR!: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            alert("VMs added successfuly!");
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Failed to add VMs");
        });
    } // end of addVMtoNLB()

    function getSelectedVMs(){
        const checkboxes = document.querySelectorAll("input[name='vms']:checked");
        return Array.from(checkboxes).map(checkbox => checkbox.value);
    } // end of getSelectedVMs()

    function loadVMs(container) {
        fetchVMs()
            .then(data => {
                renderVMs(data.vm, container);
            })
            .catch(error => {
                console.error('Error loading VMs:', error);
            });
    } // end of loadVMs()

    function loadVMsExceptExist(container, existVMList){
        fetchVMs().then(data => {
            const filteredVMs = data.vm.filter(vm => !existVMList.includes(vm.IId.NameId));
            renderVMs(filteredVMs, container);
        });
    } // end of loadVMsExceptExist()

    function fetchVMs() {
        const connConfig = '{{.ConnectionConfig}}';
        const url = `/spider/vm?ConnectionName=${encodeURIComponent(connConfig)}`;

        return fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .catch(error => {
            console.error('Error fetching VMs:', error);
            throw error;
        });
    } // end of fetch VMs()

    function renderVMs(vms, container) {
        const vmContainer = document.getElementById(container);
        vmContainer.innerHTML = '';

        if (vms.length === 0) {
            const noVMMessage = document.createElement('p');
            noVMMessage.textContent = 'No VMs available.';
            noVMMessage.style.color = 'red';
            vmContainer.appendChild(noVMMessage);
        } else {
            vms.forEach((vm) => {
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'checkbox-wrapper';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'vms';
                checkbox.value = vm.IId.NameId;
                checkbox.id = `vm-${vm.IId.NameId}`;

                const label = document.createElement('label');
                label.htmlFor = `vm-${vm.IId.NameId}`;
                label.textContent = `${vm.IId.NameId} (${vm.PrivateIP})`;

                checkboxWrapper.appendChild(checkbox);
                checkboxWrapper.appendChild(label);

                vmContainer.appendChild(checkboxWrapper);
            });
        }
    } // end of renderVMs()

    document.addEventListener('DOMContentLoaded', loadVMs);

    function delVMFromNLB(nlbName, vmName){
        const url = `/spider/nlb/${nlbName}/vms`;
        console.log(url);
        const requestBody = {
            ConnectionName: '{{.ConnectionConfig}}',
            ReqInfo: {
                VMs: [vmName]
            }
        };

        fetch(url, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            alert(`VM ${vmName} removed Successfully`);
            location.reload();
        })
        .catch(error => {
            console.error("Error:", error);
            alert(`Failed to remove VM ${vmName}`);
        });
    } // end of delVMFromNLB()


    function showNLBHealthOverlay(nlbName) {
        // Fetch the NLB health check info
        const connConfig = document.getElementById('connConfig').value;
        fetch(`/spider/nlb/${nlbName}/health?ConnectionName=${connConfig}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Populate overlay with NLB health check info
            const healthInfo = data.healthinfo;

            document.getElementById('vmHealthStatus').innerHTML = `
                Healthy VMs: ${healthInfo.HealthyVMs.length}<br>
                Unhealthy VMs: ${healthInfo.UnHealthyVMs.length}
            `;
            document.getElementById('nlbProtocol').textContent = healthInfo.Protocol;
            document.getElementById('nlbPort').textContent = healthInfo.Port;
            document.getElementById('nlbInterval').textContent = healthInfo.Interval;
            document.getElementById('nlbTimeout').textContent = healthInfo.Timeout;
            document.getElementById('nlbThreshold').textContent = healthInfo.Threshold;

            document.getElementById('healthStatusMessage').textContent = 'Health Check Completed';

            // Show the overlay
            document.getElementById('nlbHealthOverlay').style.display = 'flex';
        })
        .catch(error => {
            alert('Error fetching NLB health info: ' + error.message);
        });
    }

    function getStatusHTML(message, protocol) {
        let statusColor = '';
        let statusType = '';
        let statusMessage = '';

        if (message.startsWith('Success')) {
            statusColor = 'blue';
            statusType = 'Success';
            statusMessage = message.replace('Success: ', '');
        } else if (message.startsWith('Error')) {
            statusColor = 'red';
            statusType = 'Error';
            statusMessage = message.replace('Error: ', '');
        }

        // Add the UDP note conditionally with red Note label and spacing
        let udpNote = '';
        if (protocol.toUpperCase() === 'UDP') {
            udpNote = `
                <br><br>
                <strong style="color: red;">※ Note:</strong> 
                As UDP is connectionless, this check mainly performs a lookup and may not confirm if the server is working.
            `;
        }

        return `            
            <ul style="list-style-position: inside; padding-left: 0;">
                <li style="margin-bottom: 0; padding: 0;">
                    <strong style="color: ${statusColor};">${statusType}</strong>
                </li>
                <li style="margin-bottom: 0; padding: 0;">
                    <span>${statusMessage}</span>
                    ${udpNote}
                </li>
            </ul>
        `;
    }

    function showSystemIdOverlay(systemId) {
        const overlay = document.getElementById('system-id-overlay');
        const fullSystemIdElement = document.getElementById('fullSystemId');
        fullSystemIdElement.textContent = systemId;

        overlay.style.display = 'block';
        document.addEventListener('keydown', handleEscSystemIdOverlay);
    }

    function closeSystemIdOverlay() {
        const overlay = document.getElementById('system-id-overlay');
        overlay.style.display = 'none';
        document.removeEventListener('keydown', handleEscSystemIdOverlay);
    }

    function handleEscSystemIdOverlay(event) {
        if (event.key === "Escape") {
            closeSystemIdOverlay();
        }
    }

    function copySystemId() {
        const fullSystemIdElement = document.getElementById('fullSystemId');
        const range = document.createRange();
        range.selectNode(fullSystemIdElement);
        const selection = window.getSelection();

        selection.removeAllRanges();
        selection.addRange(range);

        try {
            document.execCommand('copy');
            closeSystemIdOverlay();
        } catch (err) {
            console.error('Error copying SystemId: ', err);
        }

        selection.removeAllRanges();
    }


</script>

</html>
