<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SecurityGroup Management</title>
<style>
    body {
        font-family: Arial, sans-serif;
        font-size: 12px;
    }
    .header-container {
        display: flex;
        align-items: flex-end;
    }
    .header-container img {
        margin-right: 10px;
        height: 28px;
    }
    .header-container h1 {
        font-size: 16px;
        margin: 0;
    }
    h2 {
        font-size: 16px;
        margin: 10px 0;
    }
    h3 {
        font-size: 14px;
        margin: 10px 0;
        margin-left: 1cm;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 0;
    }
    th, td {
        border: 1px solid black;
        padding: 6px;
        position: relative;
    }
    th {
        background-color: #f2f2f2;
        font-size: 14px;
        text-align: center;
    }
    td {
        text-align: left;
    }
    .column-num {
        width: 5%;
        text-align: center;
    }
    .center-align {
        text-align: center;
    }
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }
    .overlay-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: left;
        font-family: Arial, sans-serif;
        font-size: 12px;
    }
    .tag-overlay {
        display: none;
        position: absolute;
        background-color: white;
        border: 1px solid black;
        padding: 20px;
        z-index: 1001;
        font-family: Arial, sans-serif;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
    }
    .tag-overlay .close-btn {
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }
    .tag-overlay .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    .fixed-header {
        position: fixed;
        top: 0;
        width: 97%;
        background-color: white;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        padding: 10px 20px;
        align-items: center;
        box-shadow: 0 4px 6px -6px #222;
    }
    .fixed-action-buttons {
        display: flex;
        align-items: center;
    }
    .fixed-action-buttons button {
        margin-left: 10px;
    }
    .add-button {
        font-size: 14px;
        font-weight: bold;
        margin-left: 1px;
        margin-right: 5px;
        margin-bottom: 10px;
    }
    .mock-add-button {
        margin-right: 1px;
    }
    .content {
        margin-top: 70px;
    }
    .checkbox-cell {
        width: 5%;
        text-align: center;
    }
    .highlight {
        background-color: #fffab6
    }
    .highlight-pastel-blue {
        color: #4A90E2;
        font-weight: bold;
    }
    .select-button {
        margin-left: 10px;
        font-size: 10px;
        padding: 3px 5px;
    }
    .disabled-input {
        background-color: #f0f0f0;
        color: #a0a0a0;
        border: 1px solid #d0d0d0;
    }
    .select-list-item {
        color: #0645AD;
        text-decoration: underline;
        cursor: pointer;
    }
    .select-list-item:hover {
        color: #0B0080;
    }
    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .form-group label {
        flex: 1;
        text-align: right;
        margin-right: 10px;
    }
    .form-group input, .form-group textarea {
        flex: 2;
    }
    .form-group button {
        margin-left: 10px;
    }
    .sg-count {
        width: 50px;
    }
    .form-group .tag-inputs {
        display: flex;
        flex: 2;
        margin-left: 10px;
    }
    .form-group .tag-inputs input {
        flex: 1;
        margin-right: 5px;
    }
    .tag-input-group {
        display: flex;
        align-items: center;
        flex: 2;
    }
    .tag-input-group input {
        width: 100px;
        flex: 0.5;
        margin-right: 5px;
    }
    .tag-input-group button {
        margin-left: 5px;
    }
    .error-message {
        background-color: #F8D7DA;
        color: #721C24;
        padding: 20px;
        border-radius: 5px;
        font-size: 16px;
        margin-bottom: 20px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2000;
        text-align: center;
    }
    .error-message button {
        display: block;
        margin: 20px auto 0;
    }
    .tag-container {
        display: inline-block;
        background-color: #e1e1e1;
        border-radius: 3px;
        padding: 2px 5px;
        margin: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        max-width: calc(100% - 2ch);
    }
    .tag-container:hover {
        background-color: #c1e1c1;
    }

    .add-btn-container {
        margin-top: 5px;
    }
    .add-btn-container .add-btn {
        background-color: transparent;
        font-size: 14px;
        border: none;
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }

    .add-tag-overlay-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: left;
        font-family: Arial, sans-serif;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
        position: relative;
    }

    .sg-name {
        width: 10%;
    }
    .vpc-name {
        width: 10%;
    }
    .rules-info {
        width: 30%;
    }
    .tags {
        width: 15%;
    }

    .misc {
        width: 15%;
    }

    .overlay-dark-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1999;
        display: none;
    }

    .misc-overlay {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        width: 50%;
        height: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border: 1px solid black;
        padding: 20px;
        z-index: 2000;
        overflow-y: auto;
        user-select: text;
    }

    .misc-overlay .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }

    .misc-overlay-content {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        white-space: pre-wrap;
    }

    .misc-content {
        max-height: 2.5em;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .more-btn {
        display: none;
        background-color: transparent;
        border: none;
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }

    .misc-cell {
        position: relative;
    }

    .misc-cell .more-btn {
        position: absolute;
        right: 5px;
        bottom: 5px;
    }



    .inner-table th {
        background-color: #f9f9f9;
        font-size: 12px;
        text-align: center;
    }
    .inner-table td {
        font-size: 12px;
        text-align: center;
    }
    .inner-table .actions-cell {
        width: 60px;
        white-space: nowrap;
    }
    .inner-table .tags-cell div {
        display: inline-block;
        padding: 2px 5px;
        max-width: calc(100% - 2ch);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .inner-table button.delete-btn {
        width: auto;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
    }
    .inner-table button.add-btn {
        width: auto;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
    }
    .inner-table .name-column {
        width: 20%;
    }
    .inner-table .protocol-column {
        width: 20%;
    }
    .inner-table .port-column {
        width: 20%;
    }
    .inner-table .direction-column {
        width: 20%;
    }
    .inner-table .cidr-column {
        width: 20%;
    }
    button.add-btn {
        width: 20px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
    }
    #searchInput {
        width: 190px;
        font-family: Arial, sans-serif;
        padding-right: 2.5cm;
    }
    #clearSearch {
        position: absolute;
        right: 0.1cm;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background-color: transparent;
        cursor: pointer;
        font-family: Arial, sans-serif;
    }
    .searchContainer {
        position: relative;
        display: flex;
        align-items: center;
        padding-left: 0.5cm;
    }
    .searchContainer button {
        position: absolute;
        right: 0.5cm;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background-color: transparent;
        cursor: pointer;
        font-family: Arial, sans-serif;
    }
    .tag-overlay-content {
        position: relative;
        padding: 20px;
        border-radius: 5px;
        background-color: white;
        text-align: left;
        font-family: Arial, sans-serif;
        font-size: 12px;
    }
    .tag-overlay-input-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .tag-overlay-input-group label {
        flex: 1;
        text-align: right;
        margin-right: 10px;
    }
    .tag-overlay-input-group input {
        flex: 2;
    }
    .tag-overlay-button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .header-with-progress {
        display: flex;
        align-items: center;
        margin-bottom: 0px;
    }

    .progress-bar-container {
        width: 600px;
        margin-left: 10px;
        margin-bottom: 10px;
        height: 22px;
        background-color: #f0f5ff;
        border-radius: 4px;
        overflow: hidden;
        display: none;
        position: relative;
        z-index: 20;
    }

    .progress-bar {
        width: 0;
        height: 100%;
        background-color: #cce6ff;
        border-radius: 4px;
        transition: width 3s ease;
    }

    #timeDisplay {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        font-size: 14px;
        color: #333;
        z-index: 30;
    }

    .desc-name-cell {
        text-align: left;
        font-size: 13px;
        font-weight: bold;
    }
    .desc-name-cell .desc-system-id {
        display: block;
        font-size: 12px;
        font-weight: normal;
        color: #666;
    }

</style>
</head>
<body>
    <div class="fixed-header">
        <div class="header-container">
            <img src="/spider/adminweb/images/left-menu/securitygroup.png" alt="SecurityGroup Icon">
            <h1>SecurityGroup Management</h1>
            <div class="searchContainer">
                <input type="text" id="searchInput" onkeyup="searchKeyword()" placeholder="Search Keyword...">
                <button id="clearSearch" onclick="clearSearchInput()">X</button>
            </div>
        </div>        
        <div class="fixed-action-buttons">
            <input type="checkbox" onclick="toggleSelectAll(this)">
            <button onclick="deleteSelectedSecurityGroups()">Delete</button>
        </div>
    </div>
    
    <div class="content">
        <div class="header-with-progress">
            <button class="add-button" onclick="showOverlay()">+</button>
            <div id="mockButtonsContainer" style="display: flex; align-items: center;"></div>
            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar" id="progressBar"></div>
                <span id="timeDisplay"></span>
            </div>  
        </div>
        <table id="sg-table">
            <tr>
                <th class="column-num">#</th>
                <th class="sg-name center-align">Name</th>
                <th class="vpc-name center-align">VPC Name</th>
                <th class="rules-info">Security Rules Info</th>
                <th class="tags center-align">Tags</th>
                <th class="misc center-align">Misc</th>
                <th class="checkbox-cell center-align"><input type="checkbox" onclick="toggleSelectAll(this)"></th>
            </tr>
            {{range $index, $sg := .SecurityGroups}}
            {{ $sgNameId := $sg.IId.NameId }}
            <tr>
                <td class="column-num">{{$index | inc}}</td>
                <td class="sg-name desc-name-cell center-align">{{$sg.IId.NameId}}
                    <span class="desc-system-id">&nbsp;• {{$sg.IId.SystemId}}</span>
                </td>
                <td class="vpc-name desc-name-cell center-align">{{$sg.VpcIID.NameId}}
                    <span class="desc-system-id">&nbsp;• {{$sg.VpcIID.SystemId}}</span>
                </td>
                <td class="rules-info">
                    <table class="inner-table">
                        <tr>
                            <th class="protocol-column">Protocol</th>
                            <th class="port-column">Port Range</th>
                            <th class="direction-column">Direction</th>
                            <th class="cidr-column">CIDR</th>
                            <th class="actions-cell"><button class="add-btn" onclick="showRuleOverlay('{{$sgNameId}}')">add</button></th>
                        </tr>
                        {{range $ruleIndex, $rule := $sg.SecurityRules}}
                        <tr>
                            <td>{{$rule.IPProtocol}}</td>
                            <td>{{$rule.FromPort}} ~ {{$rule.ToPort}}</td>
                            <td>{{$rule.Direction}}</td>
                            <td>{{$rule.CIDR}}</td>
                            <td class="actions-cell">
                                <button class="delete-btn" onclick="deleteRule('{{$sgNameId}}', {{$ruleIndex}})">del</button>
                            </td>                            
                        </tr>
                        {{end}}
                    </table>
                </td>
                <td class="tags">
                    {{range $tag := $sg.TagList}}
                    <div class="tag-container" onclick="showTagOverlay(event, '{{$tag.Key}}: {{$tag.Value}}', 'SG', '{{$sgNameId}}')">{{$tag.Key}}: {{$tag.Value}}</div>
                    {{end}}
                    <div class="add-btn-container">
                        <button class="add-btn" onclick="showAddTagOverlay('{{$sgNameId}}')">+</button>
                    </div>
                </td>                
                <td class="misc misc-cell">
                    <div class="misc-content">{{range $kv := $sg.KeyValueList}}{{$kv.Key}} : {{$kv.Value}}<br>{{end}}
                    </div>
                    <button class="more-btn" onclick="showMiscOverlay(this)">more...</button>
                </td>                
                
                <td class="checkbox-cell center-align">
                    <input type="checkbox" name="deleteCheckbox" value="{{$sg.IId.NameId}}">
                </td>
            </tr>
            {{end}}
            {{if not .SecurityGroups}}
            <tr>
                <td colspan="7" class="center-align">No SecurityGroups found for this connection.</td>
            </tr>
            {{end}}
        </table>
    </div>

    <div id="overlay" class="overlay">
        <div class="overlay-content">
            <h2>Add New SecurityGroup</h2>
            <form id="addSGForm" onsubmit="event.preventDefault(); postSecurityGroup();">
                <input type="hidden" id="connConfig" value="{{.ConnectionConfig}}">
                <div id="sg-info-group">
                    <h3>SecurityGroup Info:</h3>
                    <div class="form-group">
                        <label for="sgName">Name:</label>
                        <input type="text" id="sgName" name="sgName" required style="width: 65%;">
                    </div>
                    <div class="form-group">
                        <label for="vpcName">VPC Name:</label>
                        <select id="vpcName" name="vpcName" required style="width: 65%;"></select>
                    </div>
                    <div style="margin-top: 20px;"></div>
                    <h3>Security Rules Info:</h3>
                    <div class="form-group">
                        <label for="protocol">Protocol:</label>
                        <select id="protocol" name="protocol" required style="background-color: #E6E6FA; width: 65%;">
                            <option value="TCP">TCP</option>
                            <option value="UDP">UDP</option>
                            <option value="ICMP">ICMP</option>
                            <option value="ALL">ALL</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="fromPort">From Port:</label>
                        <input type="number" id="fromPort" name="fromPort" required min="1" max="65535" style="background-color: #F5F5DC; width: 70%;">
                    </div>
                    
                    <div class="form-group">
                        <label for="toPort">To Port:</label>
                        <input type="number" id="toPort" name="toPort" required min="1" max="65535" style="background-color: #F5F5DC; width: 70%;">
                    </div>
                    
                    <div class="form-group">
                        <label for="direction">Direction:</label>
                        <div id="direction" style="display: flex; justify-content: center; align-items: center; width: 65%; background-color: #fee2e2; border-radius: 5px;">
                            <label style="margin-right: 10px; flex: 1; text-align: center;">
                                <input type="radio" name="direction" value="inbound" required checked> Inbound
                            </label>
                            <label style="flex: 1; text-align: center;">
                                <input type="radio" name="direction" value="outbound" required> Outbound
                            </label>
                        </div>
                    </div>                    

                    <div class="form-group">
                        <label for="cidr">CIDR:</label>
                        <input type="text" id="cidr" name="cidr" value="0.0.0.0/0" required style="width: 65%;">
                    </div>

                    <div class="form-group" style="padding-left: 10px;">
                        <label for="sgTags">Tags:</label>
                        <div id="sg-tag-container"></div>
                        <button type="button" onclick="addSGTagField()">+</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                    <label for="sgCount" style="margin-right: 5px;margin-left: 40px;">#:</label>
                    <input type="number" id="sgCount" name="sgCount" class="sg-count" value="1" min="1" max="10" style="width: 50px; margin-right: 10px;">                
                    <button type="submit">Add SecurityGroup</button>
                    <button type="button" onclick="hideOverlay()" style="margin-left: 10px;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="rule-overlay" class="overlay">
        <div class="overlay-content">
            <h2>Add New Security Rule</h2>
            <form id="addRuleForm" onsubmit="event.preventDefault(); addRule();">
                <input type="hidden" id="ruleSGName">
                <input type="hidden" id="connConfig" value="{{.ConnectionConfig}}">
                <div class="form-group">
                    <label for="ruleSGNameDisplay">SecurityGroup Name:</label>
                    <input type="text" id="ruleSGNameDisplay" name="ruleSGNameDisplay" readonly>
                </div>
                <div class="form-group">
                    <label for="addProtocol">Protocol:</label>
                    <select id="addProtocol" name="addProtocol" required style="background-color: #E6E6FA; width: 65%;">
                        <option value="TCP">TCP</option>
                        <option value="UDP">UDP</option>
                        <option value="ICMP">ICMP</option>
                        <option value="ALL">ALL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="addFromPort">From Port:</label>
                    <input type="number" id="addFromPort" name="addFromPort" required min="1" max="65535" style="background-color: #F5F5DC; width: 70%;">
                </div>
                <div class="form-group">
                    <label for="addToPort">To Port:</label>
                    <input type="number" id="addToPort" name="addToPort" required min="1" max="65535" style="background-color: #F5F5DC; width: 70%;">
                </div>
                <div class="form-group">
                    <label for="addDirection">Direction:</label>
                    <div id="direction" style="display: flex; justify-content: center; align-items: center; width: 65%; background-color: #fee2e2; border-radius: 5px;">
                        <label style="margin-right: 10px; flex: 1; text-align: center;">
                            <input type="radio" name="addDirection" value="inbound" required checked> Inbound
                        </label>
                        <label style="flex: 1; text-align: center;">
                            <input type="radio" name="addDirection" value="outbound" required> Outbound
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="addCidr">CIDR:</label>
                    <input type="text" id="addCidr" name="addCidr" value="0.0.0.0/0" required style="width: 65%;">
                </div>
                <div class="form-group" style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                    <button type="submit">Add Rule</button>
                    <button type="button" onclick="hideRuleOverlay()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="tag-overlay" class="tag-overlay">
        <div class="tag-overlay-content"></div>
    </div>

    <div id="add-tag-overlay" class="overlay">
        <div class="add-tag-overlay-content overlay-content"></div>
    </div>

    <input type="hidden" id="connConfig" value="{{.ConnectionConfig}}">
</body>
<script>
    let currentProvider = '';

    function showError(message, title) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        const formattedMessage = message.split('.').join('.<br>');
        errorDiv.innerHTML = `<p>${title}</p><p>${formattedMessage}</p><button onclick="closeError()">OK</button>`;
        document.body.appendChild(errorDiv);
        document.addEventListener('keydown', handleEscError);
    }

    function closeError() {
        const errorDiv = document.querySelector('.error-message');
        if (errorDiv) {
            errorDiv.remove();
            document.removeEventListener('keydown', handleEscError);
        }
    }

    function handleEscError(event) {
        if (event.key === "Escape") {
            closeError();
        }
    }

    function fetchWithProgress(url, options) {
        showProgressBar();
        
        const startTime = Date.now();
        const timerInterval = 500; 
        let timerId = setInterval(() => {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const timeDisplay = document.getElementById('timeDisplay');
            timeDisplay.textContent = `${(Math.floor(elapsedTime * 2) / 2).toFixed(1)}s`;
        }, timerInterval);

        return fetch(url, options)
            .then(response => {
                clearInterval(timerId); 
                hideProgressBar();
                return response;
            })
            .catch(error => {
                clearInterval(timerId);
                hideProgressBar();
                throw error;
            });
    }

    function showProgressBar() {
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';
        progressBarContainer.style.display = 'block';

        setTimeout(() => {
            progressBar.style.width = '100%';
        }, 100);
    }

    function hideProgressBar() {
        const progressBarContainer = document.getElementById('progressBarContainer');
        setTimeout(() => {
            progressBarContainer.style.display = 'none';
            document.getElementById('timeDisplay').textContent = ''; 
        }, 500);
    }


    function deleteSecurityGroup(sgName) {
        const connConfig = document.getElementById('connConfig').value;
        const data = {
            ConnectionName: connConfig
        };

        fetchWithProgress(`/spider/securitygroup/${sgName}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.Result === "true") {
                location.reload();
            } else {
                showError("Failed to delete SecurityGroup: " + (data.Message || "Unknown error"), "SecurityGroup Name: " + sgName);
            }
        })
        .catch(error => {
            showError("Error deleting SecurityGroup: " + error.message, "SecurityGroup Name: " + sgName);
        });
    }

    function deleteSelectedSecurityGroups() {
        const connConfig = document.getElementById('connConfig').value;
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]:checked');
        if (checkboxes.length === 0) {
            alert("Please select SecurityGroups to delete.");
            return;
        }

        if (!confirm("Are you sure you want to delete the selected SecurityGroups?")) {
            return;
        }

        const deletePromises = Array.from(checkboxes).map(checkbox => {
            const sgName = checkbox.value;
            const data = {
                ConnectionName: connConfig
            };

            return fetchWithProgress(`/spider/securitygroup/${sgName}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.message);
                    });
                }
                return response.json();
            });
        });

        Promise.all(deletePromises)
            .then(dataList => {
                let allSuccess = true;
                dataList.forEach((data, index) => {
                    if (data.Result !== "true") {
                        allSuccess = false;
                        showError("Failed to delete some SecurityGroups: " + (data.Message || "Unknown error"), "SecurityGroup Name: " + checkboxes[index].value);
                    }
                });
                if (allSuccess) {
                    location.reload();
                }
            })
            .catch(error => {
                showError("Error deleting SecurityGroups: " + error.message, "Multiple SecurityGroups");
            });
    }

    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]');
        for (const checkbox of checkboxes) {
            checkbox.checked = source.checked;
        }
    }

    function validateForm() {
        const sgName = document.getElementById('sgName').value.trim();
        const vpcName = document.getElementById('vpcName').value.trim();
        const fromPort = document.getElementById('fromPort').value.trim();
        const toPort = document.getElementById('toPort').value.trim();
        const protocol = document.getElementById('protocol').value.trim();
        const direction = document.querySelector('input[name="direction"]:checked');
        const cidr = document.getElementById('cidr').value.trim();

        if (!sgName || !vpcName || !fromPort || !toPort || !protocol || !direction || !cidr) {
            alert("Please fill in all the fields.");
            return false;
        }
        return true;
    }

    function postSecurityGroup() {
        if (!validateForm()) {
            return;
        }

        const sgCount = parseInt(document.getElementById('sgCount').value);
        if (sgCount > 1) {
            if (!confirm(`Are you sure you want to create ${sgCount} Security Groups?`)) {
                return;
            }
        }

        const connConfig = document.getElementById('connConfig').value;
        const vpcName = document.getElementById('vpcName').value;
        const fromPort = document.getElementById('fromPort').value;
        const toPort = document.getElementById('toPort').value;
        const protocol = document.getElementById('protocol').value;
        const direction = document.querySelector('input[name="direction"]:checked').value;
        const cidr = document.getElementById('cidr').value;

        const tags = Array.from(document.querySelectorAll('.sg-tag-input')).map(tagInput => ({
            Key: tagInput.querySelector('.sg-tag-key').value,
            Value: tagInput.querySelector('.sg-tag-value').value
        }));

        const ruleInfo = [{
            FromPort: fromPort,
            ToPort: toPort,
            IPProtocol: protocol,
            Direction: direction,
            CIDR: cidr
        }];

        const sgPromises = Array.from({ length: sgCount }).map((_, index) => {
            const sgName = sgCount > 1 ? `${document.getElementById('sgName').value}-${index + 1}` : document.getElementById('sgName').value;

            const data = {
                ConnectionName: connConfig,
                ReqInfo: {
                    Name: sgName,
                    VPCName: vpcName,
                    SecurityRules: ruleInfo,
                    TagList: tags
                }
            };

            return fetchWithProgress('/spider/securitygroup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.message);
                    });
                }
                return response.json();
            });
        });


        Promise.all(sgPromises)
            .then(() => {
                location.reload();
            })
            .catch(error => {
                showError("Error creating SecurityGroups: " + error.message, "SecurityGroup Creation Error");
            });
    }

    function showOverlay() {
        loadVPCs(); 
        const region = '{{.RegionName}}';
        const sgNameInput = document.getElementById('sgName');
        const vpcNameInput = document.getElementById('vpcName');

        sgNameInput.value = `${region}-sg-${Math.random().toString(36).substring(2, 5)}`;
        document.getElementById('fromPort').value = '1';
        document.getElementById('toPort').value = '65535';
        document.getElementById('protocol').value = 'TCP';
        document.querySelector('input[name="direction"][value="inbound"]').checked = true;
        document.getElementById('cidr').value = '0.0.0.0/0';

        document.getElementById('protocol').addEventListener('change', handleProtocolChange);

        document.getElementById('overlay').style.display = 'flex';
        document.addEventListener('keydown', handleEsc);
        clearFormFields();
    }

    function handleProtocolChange() {
        const protocol = document.getElementById('protocol').value;
        const fromPortInput = document.getElementById('fromPort');
        const toPortInput = document.getElementById('toPort');

        if (protocol === 'ALL' || protocol === 'ICMP') {
            fromPortInput.value = '-1';
            toPortInput.value = '-1';
            fromPortInput.disabled = true;
            toPortInput.disabled = true;
        } else {
            fromPortInput.value = '1';
            toPortInput.value = '65535';
            fromPortInput.disabled = false;
            toPortInput.disabled = false;
        }
    }

    function clearFormFields() {
        const region = '{{.RegionName}}';
        const sgNameInput = document.getElementById('sgName');

        sgNameInput.value = `${region}-sg-${Math.random().toString(36).substring(2, 5)}`;
        document.getElementById('fromPort').value = '1';
        document.getElementById('toPort').value = '65535';
        document.getElementById('protocol').value = 'TCP';
        document.querySelector('input[name="direction"][value="inbound"]').checked = true;
        document.getElementById('cidr').value = '0.0.0.0/0';

        document.querySelectorAll('.sg-tag-input').forEach(tagInput => tagInput.remove());
        
        document.getElementById('protocol').addEventListener('change', handleProtocolChange);
    }

    function hideOverlay() {
        document.getElementById('overlay').style.display = 'none';
        document.removeEventListener('keydown', handleEsc);
        clearFormFields();
    }

    function handleEsc(event) {
        if (event.key === "Escape") {
            hideOverlay();
        }
    }

    function showRuleOverlay(sgName) {
        const fromPortInput = document.getElementById('addFromPort');
        const toPortInput = document.getElementById('addToPort');
        const protocolInput = document.getElementById('addProtocol');
        const directionInput = document.getElementById('addDirection');
        const cidrInput = document.getElementById('addCidr');
        const sgNameInput = document.getElementById('ruleSGName');
        const sgNameDisplay = document.getElementById('ruleSGNameDisplay');

        sgNameInput.value = sgName;
        sgNameDisplay.value = sgName;

        fromPortInput.value = '1';
        toPortInput.value = '65535';
        protocolInput.value = 'TCP';
        document.querySelector('input[name="addDirection"][value="inbound"]').checked = true;
        cidrInput.value = '0.0.0.0/0';

        document.getElementById('addProtocol').addEventListener('change', handleAddProtocolChange);

        document.getElementById('rule-overlay').style.display = 'flex';
        document.addEventListener('keydown', handleEscRule);
    }

    function handleAddProtocolChange() {
        const protocol = document.getElementById('addProtocol').value;
        const fromPortInput = document.getElementById('addFromPort');
        const toPortInput = document.getElementById('addToPort');

        if (protocol === 'ALL' || protocol === 'ICMP') {
            fromPortInput.value = '-1';
            toPortInput.value = '-1';
            fromPortInput.disabled = true;
            toPortInput.disabled = true;
        } else {
            fromPortInput.value = '1';
            toPortInput.value = '65535';
            fromPortInput.disabled = false;
            toPortInput.disabled = false;
        }
    }

    function hideRuleOverlay() {
        document.getElementById('rule-overlay').style.display = 'none';
        document.removeEventListener('keydown', handleEscRule);
    }

    function handleEscRule(event) {
        if (event.key === "Escape") {
            hideRuleOverlay();
        }
    }

    function addRule() {
        const sgName = document.getElementById('ruleSGName').value;
        const connConfig = document.getElementById('connConfig').value;
        const fromPort = document.getElementById('addFromPort').value;
        const toPort = document.getElementById('addToPort').value;
        const protocol = document.getElementById('addProtocol').value;
        const direction = document.querySelector('input[name="addDirection"]:checked').value;
        const cidr = document.getElementById('addCidr').value;

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                RuleInfoList: [{
                    FromPort: fromPort,
                    ToPort: toPort,
                    IPProtocol: protocol,
                    Direction: direction,
                    CIDR: cidr
                }]
            }
        };

        fetchWithProgress(`/spider/securitygroup/${sgName}/rules`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        }).then(() => {
            location.reload();
        }).catch(error => {
            showError("Error creating SecurityGroup Rule: " + error.message, "SecurityGroup Name: " + sgName);
        });
    }

    function deleteRule(sgName, ruleIndex) {
        if (!confirm(`Are you sure you want to delete this security rule?`)) {
            return;
        }

        const connConfig = document.getElementById('connConfig').value;
        const sgRow = Array.from(document.querySelectorAll('#sg-table tr')).find(tr => {
            const sgNameCell = tr.querySelector('.sg-name');
            return sgNameCell && sgNameCell.textContent.trim() === sgName;
        });

        if (!sgRow) {
            console.error(`Unable to find the row for SecurityGroup: ${sgName}`);
            return;
        }

        const innerTable = sgRow.querySelector('.inner-table');
        const ruleRow = innerTable ? innerTable.rows[ruleIndex + 1] : null;

        if (!ruleRow) {
            console.error(`Unable to find the rule at index ${ruleIndex} for SecurityGroup: ${sgName}`);
            return;
        }

        const protocol = ruleRow.cells[0].innerText.trim();
        const portRange = ruleRow.cells[1].innerText.trim();
        const [fromPort, toPort] = portRange.split(' ~ ').map(port => port.trim());
        const direction = ruleRow.cells[2].innerText.trim();
        const cidr = ruleRow.cells[3].innerText.trim();

        let parsedFromPort = fromPort;
        let parsedToPort = toPort;

        if (protocol === 'ICMP') {
            parsedFromPort = "-1";
            parsedToPort = "-1";
        } else {
            parsedFromPort = fromPort.toString();
            parsedToPort = toPort.toString();
        }

        const ruleInfo = {
            FromPort: parsedFromPort,
            ToPort: parsedToPort,
            IPProtocol: protocol,
            Direction: direction,
            CIDR: cidr
        };

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                RuleInfoList: [ruleInfo]
            }
        };

        fetchWithProgress(`/spider/securitygroup/${sgName}/rules`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.Result === "true") {
                location.reload();
            } else {
                showError("Failed to delete security rule: " + (data.Message || "Unknown error"), "SecurityGroup Name: " + sgName);
            }
        })
        .catch(error => {
            showError("Error deleting security rule: " + error.message, "SecurityGroup Name: " + sgName);
        });
    }


    function showTagOverlay(event, tag, resourceType, resourceName) {
        event.stopPropagation();
        const tagOverlay = document.getElementById('tag-overlay');
        const tagOverlayContent = document.querySelector('.tag-overlay-content');
        tagOverlayContent.innerHTML = `
            <button class="close-btn" onclick="closeTagOverlay()">x</button>
            <p>${tag}</p>
            <div class="button-group">
                <button onclick="deleteTag('${tag}', '${resourceType}', '${resourceName}')">Delete</button>
                <button onclick="closeTagOverlay()">Cancel</button>
            </div>
        `;
        tagOverlay.style.display = 'block';
        tagOverlay.style.top = `${event.clientY}px`;
        tagOverlay.style.left = `${event.clientX}px`;
        document.addEventListener('click', handleClickOutsideOverlay);
        document.addEventListener('keydown', handleEscTagOverlay);
    }

    function deleteTag(tag, resourceType, resourceName) {
        const connConfig = document.getElementById('connConfig').value;
        const [tagKey, tagValue] = tag.split(': ');

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                ResourceType: resourceType.trim(),
                ResourceName: resourceName.trim()
            }
        };

        fetchWithProgress(`/spider/tag/${tagKey.trim()}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        }).then(() => {
            closeTagOverlay();
            location.reload();
        }).catch(error => {
            showError("Error deleting tag: " + error.message, "Resource Name: " + resourceName);
        });
    }

    function closeTagOverlay() {
        const tagOverlay = document.getElementById('tag-overlay');
        tagOverlay.style.display = 'none';
        document.removeEventListener('click', handleClickOutsideOverlay);
        document.removeEventListener('keydown', handleEscTagOverlay);
    }

    function handleEscTagOverlay(event) {
        if (event.key === "Escape") {
            closeTagOverlay();
        }
    }

    function handleClickOutsideOverlay(event) {
        const tagOverlay = document.getElementById('tag-overlay');
        if (!tagOverlay.contains(event.target)) {
            closeTagOverlay();
        }
    }

    function addSGTagField() {
        const tagContainer = document.getElementById('sg-tag-container');
        const tagInput = document.createElement('div');
        tagInput.className = 'sg-tag-input tag-input-group';
        tagInput.innerHTML = `
            <input type="text" class="sg-tag-key" placeholder="Key" required>
            <input type="text" class="sg-tag-value" placeholder="Value" required>
            <button type="button" onclick="removeTagField(this)">-</button>
        `;
        tagContainer.appendChild(tagInput);
    }

    function removeTagField(button) {
        button.parentElement.remove();
    }

    function showAddTagOverlay(sgName) {
        const addTagOverlay = document.getElementById('add-tag-overlay');
        const addTagOverlayContent = document.querySelector('.add-tag-overlay-content');
        addTagOverlayContent.innerHTML = `
            <div class="tag-overlay-input-group">
                <label for="tagOverlayTagKey">Tag Key:</label>
                <input type="text" id="tagOverlayTagKey" name="tagKey" required>
            </div>
            <div class="tag-overlay-input-group">
                <label for="tagOverlayTagValue">Tag Value:</label>
                <input type="text" id="tagOverlayTagValue" name="tagValue" required>
            </div>
            <div class="tag-overlay-button-group">
                <button onclick="addTag('${sgName}')">Add</button>
                <button onclick="closeAddTagOverlay()">Cancel</button>
            </div>
        `;
        addTagOverlay.style.display = 'flex';
        document.addEventListener('keydown', handleEscAddTagOverlay);
    }

    function closeAddTagOverlay() {
        const addTagOverlay = document.getElementById('add-tag-overlay');
        addTagOverlay.style.display = 'none';
        document.removeEventListener('keydown', handleEscAddTagOverlay);
    }

    function handleEscAddTagOverlay(event) {
        if (event.key === "Escape") {
            closeAddTagOverlay();
        }
    }

    function addTag(sgName) {
        const tagKey = document.getElementById('tagOverlayTagKey').value;
        const tagValue = document.getElementById('tagOverlayTagValue').value;
        const connConfig = document.getElementById('connConfig').value;

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                ResourceType: 'SG',
                ResourceName: sgName,
                Tag: { Key: tagKey, Value: tagValue }
            }
        };

        fetchWithProgress('/spider/tag', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        }).then(() => {
            closeAddTagOverlay();
            location.reload();
        }).catch(error => {
            showError("Error adding tag: " + error.message, "SecurityGroup Name: " + sgName);
        });
    }

    function createMultipleSecurityGroups(count) {
        const connConfig = document.getElementById('connConfig').value;

        fetch(`/spider/vpc?ConnectionName=${encodeURIComponent(connConfig)}`)
            .then(response => response.json())
            .then(vpcData => {
                if (!vpcData.vpc || vpcData.vpc.length === 0) {
                    throw new Error('No VPCs available to use for creating SecurityGroups.');
                }
                const vpcName = vpcData.vpc[0].IId.NameId;

                const sgPromises = Array.from({ length: count }).map(() => {
                    const sgName = `mock-sg-${Math.random().toString(36).substring(2, 7)}`;
                    const fromPort = '1';
                    const toPort = '65535';
                    const protocol = 'TCP';
                    const direction = 'inbound';
                    const cidr = '0.0.0.0/0';

                    const ruleInfo = [{
                        FromPort: fromPort,
                        ToPort: toPort,
                        IPProtocol: protocol,
                        Direction: direction,
                        CIDR: cidr
                    }];

                    const data = {
                        ConnectionName: connConfig,
                        ReqInfo: {
                            Name: sgName,
                            VPCName: vpcName,
                            SecurityRules: ruleInfo,
                            TagList: []
                        }
                    };

                    return fetchWithProgress('/spider/securitygroup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    }).then(response => {
                        if (!response.ok) {
                            return response.json().then(error => {
                                throw new Error(error.message);
                            });
                        }
                        return response.json();
                    });
                });

                Promise.all(sgPromises)
                    .then(() => {
                        location.reload();
                    })
                    .catch(error => {
                        showError("Error creating SecurityGroups: " + error.message, "SecurityGroup Creation Error");
                    });
            })
            .catch(error => {
                showError("Error fetching VPCs: " + error.message, "VPC Fetch Error");
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchWithProgress('/spider/connectionconfig/{{.ConnectionConfig}}')
            .then(response => response.json())
            .then(data => {
                currentProvider = data.ProviderName;
                if (currentProvider === 'MOCK') {
                    const mockButtonsContainer = document.getElementById('mockButtonsContainer');

                    const button10 = document.createElement('button');
                    button10.className = 'mock-add-button add-button';
                    button10.textContent = '+10';
                    button10.onclick = () => createMultipleSecurityGroups(10);

                    const button20 = document.createElement('button');
                    button20.className = 'mock-add-button add-button';
                    button20.textContent = '+50';
                    button20.onclick = () => createMultipleSecurityGroups(50);

                    mockButtonsContainer.appendChild(button10);
                    mockButtonsContainer.appendChild(button20);
                }
            })
            .catch(error => {
                showError("Error loading connection configuration: " + error.message, "Connection Config Error");
            });
    });


    function searchKeyword() {
        let input, filter, table, tr, td, i, j, k, innerTable, innerTr, innerTd, txtValue;
        input = document.getElementById('searchInput');
        filter = input.value.toUpperCase().trim();
        if (!filter) {
            clearSearchInput();
            return;
        }

        table = document.getElementById('sg-table');
        tr = table.getElementsByTagName('tr');
        
        for (i = 1; i < tr.length; i++) {
            for (j = 0; j < tr[i].cells.length; j++) {
                td = tr[i].cells[j];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (td.querySelector('table.inner-table')) {
                        innerTable = td.querySelector('table.inner-table');
                        innerTr = innerTable.getElementsByTagName('tr');
                        for (k = 1; k < innerTr.length; k++) {
                            for (let l = 0; l < innerTr[k].cells.length; l++) {
                                innerTd = innerTr[k].cells[l];
                                txtValue = innerTd.textContent || innerTd.innerText;
                                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                                    innerTd.classList.add('highlight');
                                } else {
                                    innerTd.classList.remove('highlight');
                                }
                            }
                        }
                    } else {
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            td.classList.add('highlight');
                        } else {
                            td.classList.remove('highlight');
                        }
                    }
                }
            }
        }
    }

    function clearSearchInput() {
        document.getElementById("searchInput").value = "";
        let table = document.getElementById('sg-table');
        let tr = table.getElementsByTagName('tr');
        for (let i = 1; i < tr.length; i++) {
            for (let j = 0; j < tr[i].cells.length; j++) {
                tr[i].cells[j].classList.remove('highlight');
                if (tr[i].cells[j].querySelector('table.inner-table')) {
                    let innerTable = tr[i].cells[j].querySelector('table.inner-table');
                    let innerTr = innerTable.getElementsByTagName('tr');
                    for (let k = 1; k < innerTr.length; k++) {
                        for (let l = 0; l < innerTr[k].cells.length; l++) {
                            innerTr[k].cells[l].classList.remove('highlight');
                        }
                    }
                }
            }
        }
    }

    function loadVPCs() {
        const connConfig = document.getElementById('connConfig').value;
        const url = `/spider/vpc?ConnectionName=${encodeURIComponent(connConfig)}`;

        fetchWithProgress(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const vpcSelect = document.getElementById('vpcName');
            vpcSelect.innerHTML = '';
            if (data.vpc.length > 0) {
                data.vpc.forEach((vpc, index) => {
                    const option = document.createElement('option');
                    option.value = vpc.IId.NameId;
                    option.text = `${vpc.IId.NameId} (${vpc.IPv4_CIDR})`;
                    vpcSelect.appendChild(option);
                    if (index === 0) {
                        vpcSelect.value = vpc.IId.NameId;
                    }
                });
            } else {
                const option = document.createElement('option');
                option.value = "";
                option.text = "No VPCs. Create one.";
                vpcSelect.appendChild(option);
                vpcSelect.disabled = true;
            }
        })
        .catch(error => {
            console.error('Error loading VPCs:', error);
            showError("Error loading VPCs: " + error.message, "VPC Load Error");
        });
    }

    function updateDirectionBackground(selectElement) {
        if (selectElement.value === "outbound") {
            selectElement.style.backgroundColor = "#FFCCCC";
        } else {
            selectElement.style.backgroundColor = "#FFFFFF";
        }
    }

    function showMiscOverlay(button) {
        const miscContent = button.previousElementSibling.innerHTML;

        const overlayDarkBackground = document.createElement('div');
        overlayDarkBackground.className = 'overlay-dark-background';
        document.body.appendChild(overlayDarkBackground);

        const overlay = document.createElement('div');
        overlay.className = 'misc-overlay';
        overlay.innerHTML = `
            <button class="close-btn">x</button>
            <div class="misc-overlay-content" tabindex="0">${miscContent}</div>
        `;

        document.body.appendChild(overlay);
        overlayDarkBackground.style.display = 'block';
        overlay.style.display = 'block';

        const overlayContent = overlay.querySelector('.misc-overlay-content');
        overlayContent.focus();

        document.addEventListener('keydown', handleEscKey);
        overlayDarkBackground.addEventListener('click', handleClickOutside);
        overlay.querySelector('.close-btn').addEventListener('click', closeMiscOverlay);

        function closeMiscOverlay() {
            if (overlay) overlay.remove();
            if (overlayDarkBackground) overlayDarkBackground.remove();
            document.removeEventListener('keydown', handleEscKey);
            overlayDarkBackground.removeEventListener('click', handleClickOutside);
        }

        function handleEscKey(event) {
            if (event.key === 'Escape') {
                closeMiscOverlay();
            }
        }

        function handleClickOutside(event) {
            if (event.target === overlayDarkBackground) {
                closeMiscOverlay();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const miscCells = document.querySelectorAll('.misc-cell');

        miscCells.forEach(cell => {
            const content = cell.querySelector('.misc-content');
            const button = cell.querySelector('.more-btn');

            if (content.scrollHeight > content.clientHeight) {
                button.style.display = 'inline-block';
            } else {
                button.style.display = 'none';
            }
        });
    });

</script>
</html>
